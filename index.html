<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Online - SMAN 1 Dramaga (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .bg-maroon-800 { background-color: #800000; }
        .bg-maroon-700 { background-color: #990000; }
        .bg-maroon-600 { background-color: #B20000; }
        .text-maroon-800 { color: #800000; }
        .border-maroon-800 { border-color: #800000; }
        .gradient-bg {
            background: linear-gradient(135deg, #4a0404, #800000);
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #800000;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #660000;
        }
        .input-field {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #800000;
            box-shadow: 0 0 0 2px rgba(128, 0, 0, 0.2);
        }
        #camera-modal video {
            width: 100%;
            border-radius: 8px;
            transform: scaleX(-1); /* Mirror effect */
        }
        #camera-modal canvas {
            display: none;
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Container Utama -->
    <div id="app" class="min-h-screen flex items-center justify-center p-4 gradient-bg">

        <!-- Halaman Login -->
        <div id="loginPage" class="w-full max-w-md">
            <div class="card p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-maroon-800">Absensi Online üè´</h1>
                    <p class="text-slate-500 mt-2 font-semibold">SMAN 1 DRAMAGA</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="role" class="block text-sm font-medium text-slate-600 mb-1">Pilih Peran Anda</label>
                        <select id="role" class="input-field bg-white">
                            <option value="siswa">Siswa</option>
                            <option value="guru">Guru</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div id="siswaSelection" class="space-y-4">
                        <div>
                            <label for="kelasSelect" class="block text-sm font-medium text-slate-600 mb-1">Pilih Kelas</label>
                            <select id="kelasSelect" class="input-field bg-white"><option>Memuat...</option></select>
                        </div>
                         <div>
                            <label for="userName" class="block text-sm font-medium text-slate-600 mb-1">Pilih Nama Siswa</label>
                            <select id="userName" class="input-field bg-white"><option>Pilih Kelas Dulu</option></select>
                        </div>
                    </div>

                    <div id="guruSelection" class="hidden">
                        <label for="guruName" class="block text-sm font-medium text-slate-600 mb-1">Pilih Nama Anda</label>
                        <select id="guruName" class="input-field bg-white"><option>Memuat...</option></select>
                    </div>

                    <div id="adminCredentials" class="hidden space-y-4">
                        <div>
                            <label for="adminUser" class="block text-sm font-medium text-slate-600 mb-1">Username</label>
                            <input type="text" id="adminUser" class="input-field" placeholder="admin">
                        </div>
                        <div>
                            <label for="adminPass" class="block text-sm font-medium text-slate-600 mb-1">Password</label>
                            <input type="password" id="adminPass" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="loginBtn" class="btn btn-primary w-full">Login</button>
                </div>

                <div class="mt-6 text-center text-xs text-slate-400 bg-slate-50 p-3 rounded-lg">
                    <p class="font-bold">Informasi Login:</p>
                    <p><span class="font-semibold">Siswa/Guru:</span> Cukup pilih kelas dan nama.</p>
                    <p><span class="font-semibold">Admin:</span> Username: <span class="font-mono">admin</span>, Password: <span class="font-mono">admin123</span></p>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard" class="hidden w-full max-w-6xl">
            <header class="card p-4 mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-maroon-800">Dashboard Absensi üìã</h2>
                    <p id="welcomeMessage" class="text-slate-500"></p>
                </div>
                <button id="logoutBtn" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">
                    <i class="fa fa-sign-out-alt mr-2"></i>Logout
                </button>
            </header>
            <main id="dashboardContent" class="space-y-6"></main>
        </div>
    </div>
    
    <!-- TEMPLATES -->
    <template id="siswa-dashboard">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Absensi Harian Siswa üì∏</h3>
                    <div class="text-center space-y-4">
                         <p class="text-sm text-slate-500">Silakan lakukan absensi masuk atau pulang dengan foto selfie.</p>
                         <div id="absensi-status" class="font-bold text-xl p-3 rounded-lg bg-slate-100">Memeriksa...</div>
                         <div id="foto-bukti-container" class="hidden mt-4">
                            <p class="text-sm font-semibold mb-2">Bukti Foto:</p>
                            <div class="flex justify-center gap-4">
                                <div class="text-center">
                                    <p class="text-xs text-slate-500">Masuk</p>
                                    <img id="fotoMasuk" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                                </div>
                                 <div class="text-center">
                                    <p class="text-xs text-slate-500">Pulang</p>
                                    <img id="fotoPulang" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                                </div>
                            </div>
                         </div>
                         <div class="flex justify-center gap-4 mt-4">
                              <button id="btn-absen-masuk" data-type="masuk" class="btn-absen btn btn-primary w-1/2">
                                  <i class="fa fa-camera mr-2"></i>Absen Masuk
                              </button>
                              <button id="btn-absen-pulang" data-type="pulang" class="btn-absen btn bg-orange-500 text-white w-1/2 hover:bg-orange-600" disabled>
                                  <i class="fa fa-camera mr-2"></i>Absen Pulang
                              </button>
                         </div>
                         <p class="text-xs text-slate-400 mt-2">Geotagging lokasi Anda akan aktif secara otomatis.</p>
                    </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Ajukan Izin/Sakit üíå</h3>
                    <form id="izinForm" class="space-y-3">
                        <select id="izinTipe" class="input-field bg-white">
                            <option value="Izin">Izin</option>
                            <option value="Sakit">Sakit</option>
                        </select>
                        <textarea id="izinAlasan" class="input-field" rows="3" placeholder="Contoh: demam tinggi, ada surat dokter terlampir." required></textarea>
                        <div>
                            <label class="text-sm font-medium text-slate-600">Upload Surat (opsional)</label>
                            <input id="izinFile" type="file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-maroon-50 file:text-maroon-700 hover:file:bg-maroon-100 mt-1"/>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Kirim Laporan</button>
                    </form>
                </div>
            </div>
            <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Info & Riwayat üèÜ</h3>
                     <div class="text-center bg-slate-100 text-slate-800 p-4 rounded-lg">
                        <i class="fas fa-history text-3xl mb-2"></i>
                        <p class="font-bold">Riwayat Kehadiran</p>
                        <p id="riwayat-kehadiran" class="text-xs mt-2">Memuat data...</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="guru-dashboard">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                 <div class="card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold">Daftar Hadir Digital üìù - Kelas <span id="guru-kelas" class="font-semibold"></span></h3>
                            <p class="text-sm text-slate-500 mb-4">Pelajaran: <span id="guru-mapel" class="font-semibold"></span></p>
                        </div>
                    </div>
                    <div id="rekap-kelas-container" class="mb-6">
                        <h4 class="font-bold text-sm mb-2 text-slate-600">Rekap Kelas Hari Ini</h4>
                        <div id="rekap-kelas-content" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <p class="col-span-full text-slate-500">Memuat rekap...</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                                <tr>
                                    <th class="px-6 py-3">Nama Siswa</th>
                                    <th class="px-6 py-3">Status Hari Ini</th>
                                </tr>
                            </thead>
                            <tbody id="daftarHadirSiswa"><tr class="bg-white"><td colspan="2" class="text-center p-4">Memuat daftar siswa...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Absensi Guru üßë‚Äçüè´</h3>
                    <div class="text-center space-y-4">
                         <div id="absensi-status-guru" class="font-bold text-xl p-3 rounded-lg bg-slate-100">Memeriksa...</div>
                         <div id="foto-bukti-container-guru" class="hidden mt-4">
                             <img id="fotoMasukGuru" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200 mx-auto" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                         </div>
                         <div class="flex justify-center gap-4 mt-4">
                              <button id="btn-absen-masuk-guru" data-type="masuk" class="btn-absen-guru btn btn-primary w-full">
                                  <i class="fa fa-camera mr-2"></i>Absen Masuk
                              </button>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="admin-dashboard">
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                     <h3 class="text-lg font-bold mb-4">Monitoring Real-Time üìä</h3>
                     <div id="admin-stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Siswa Hadir</p></div>
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Siswa Izin/Sakit</p></div>
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Siswa Alpa</p></div>
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Guru Hadir</p></div>
                     </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Rekap Laporan Bulanan üìÇ</h3>
                     <p class="text-sm text-slate-500 mb-4">Fitur ini akan segera tersedia.</p>
                     <div class="flex gap-4">
                         <button class="btn bg-red-600 text-white flex-1 hover:bg-red-700" disabled><i class="fa fa-file-pdf mr-2"></i>Download PDF</button>
                         <button class="btn bg-green-600 text-white flex-1 hover:bg-green-700" disabled><i class="fa fa-file-excel mr-2"></i>Download Excel</button>
                     </div>
                 </div>
            </div>
            <div class="space-y-6">
                 <div class="card p-6">
                     <h3 class="text-lg font-bold mb-4">Konfirmasi Izin/Sakit Siswa ‚úÖ</h3>
                     <div id="izin-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-sm text-slate-500 text-center py-4">Memuat data izin...</p>
                     </div>
                 </div>
            </div>
       </div>
    </template>
    
    <!-- MODALS -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center card">
            <p id="alert-message" class="mb-4 text-slate-700"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-8">OK</button>
        </div>
    </div>

    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md card relative">
            <button id="close-camera-btn" class="absolute top-2 right-2 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            <h3 class="text-lg font-bold mb-4 text-center">Ambil Foto Selfie</h3>
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <img id="photo-preview" class="hidden w-full rounded-lg mt-4">
            <div class="mt-4 flex gap-4">
                <button id="capture-btn" class="btn btn-primary w-full"><i class="fa fa-camera mr-2"></i>Ambil Gambar</button>
                <button id="recapture-btn" class="btn bg-slate-500 text-white w-full hidden"><i class="fa fa-redo mr-2"></i>Ulangi</button>
                <button id="confirm-photo-btn" class="btn bg-green-500 text-white w-full hidden"><i class="fa fa-check mr-2"></i>Konfirmasi</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- SUPABASE SETUP ---
        // PENTING: Ganti dengan URL dan Kunci Anon dari proyek Supabase Anda!
        const SUPABASE_URL = 'https://qwjidphtepjklmpgpsai.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3amlkcGh0ZXBqa2xtcGdwc2FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MzA1MTMsImV4cCI6MjA3NjUwNjUxM30.8WYPttRLyA0heSJRQa_kmi1L6VinWrNbZg6XQhbwsF4';
        
        // Cek jika placeholder belum diganti
        if (SUPABASE_URL.includes('URL_PROYEK_ANDA') || SUPABASE_ANON_KEY.includes('KUNCI_ANON_ANDA')) {
            document.body.innerHTML = `<div class="h-screen w-screen flex items-center justify-center bg-red-100 text-red-800 p-8"><div class="text-center">
                <h1 class="text-2xl font-bold mb-4">Konfigurasi Supabase Diperlukan!</h1>
                <p>Silakan buka file <strong>index.html</strong>, cari bagian <strong>SUPABASE SETUP</strong> di dalam tag &lt;script&gt;, dan ganti placeholder <code>SUPABASE_URL</code> dan <code>SUPABASE_ANON_KEY</code> dengan kredensial dari proyek Supabase Anda.</p>
                <p class="mt-4 text-sm">Lihat konsol browser (F12) untuk detail lebih lanjut.</p>
            </div></div>`;
            console.error("Kesalahan Konfigurasi: Anda harus mengganti placeholder SUPABASE_URL dan SUPABASE_ANON_KEY di dalam file HTML.");
            return;
        }

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabaseClient; // for debugging

        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('loginPage'), dashboard = document.getElementById('dashboard');
        const roleSelect = document.getElementById('role');
        const siswaSelection = document.getElementById('siswaSelection'), guruSelection = document.getElementById('guruSelection'), adminCredentials = document.getElementById('adminCredentials');
        const kelasSelect = document.getElementById('kelasSelect'), userNameSelect = document.getElementById('userName'), guruNameSelect = document.getElementById('guruName');
        const loginBtn = document.getElementById('loginBtn'), logoutBtn = document.getElementById('logoutBtn');
        const dashboardContent = document.getElementById('dashboardContent'), welcomeMessage = document.getElementById('welcomeMessage');
        const customAlert = document.getElementById('custom-alert'), alertMessage = document.getElementById('alert-message'), alertOkBtn = document.getElementById('alert-ok-btn');
        const cameraModal = document.getElementById('camera-modal'), closeCameraBtn = document.getElementById('close-camera-btn'), cameraFeed = document.getElementById('camera-feed'), cameraCanvas = document.getElementById('camera-canvas'), captureBtn = document.getElementById('capture-btn'), photoPreview = document.getElementById('photo-preview'), recaptureBtn = document.getElementById('recapture-btn'), confirmPhotoBtn = document.getElementById('confirm-photo-btn');
        
        let stream;
        let currentUser = {};

        // --- HELPER FUNCTIONS ---
        const showAlert = (message) => { alertMessage.textContent = message; customAlert.classList.remove('hidden'); };
        alertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        const showLoader = (btn) => {
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Memproses...`;
        };

        const hideLoader = (btn, originalText) => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        const getTodayDate = () => new Date().toISOString().split('T')[0];

        // --- DATA FETCHING & POPULATION ---
        const populateKelasSelect = async () => {
            const { data, error } = await supabaseClient.from('siswa').select('kelas');
            if (error) return console.error("Gagal mengambil data kelas:", error);
            
            const kelasSet = new Set(data.map(s => s.kelas));
            const sortedKelas = Array.from(kelasSet).sort((a, b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
            
            if (sortedKelas.length === 0) {
                 kelasSelect.innerHTML = `<option>Belum ada data</option>`;
                 return;
            }
            
            kelasSelect.innerHTML = sortedKelas.map(k => `<option value="${k}">${k}</option>`).join('');
            await populateSiswaSelect(kelasSelect.value);
        };
        
        const populateSiswaSelect = async (kelas) => {
            userNameSelect.innerHTML = `<option>Memuat...</option>`;
            const { data, error } = await supabaseClient.from('siswa').select('name').eq('kelas', kelas);
            if (error) return console.error("Gagal mengambil data siswa:", error);
            if (data.length === 0) {
                 userNameSelect.innerHTML = `<option>Tidak ada siswa</option>`;
                 return;
            }
            userNameSelect.innerHTML = data.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };
        
        const populateGuruSelect = async () => {
            const { data, error } = await supabaseClient.from('guru').select('name, kelas');
            if (error) return console.error("Gagal mengambil data guru:", error);
            
             if (data.length === 0) {
                 guruNameSelect.innerHTML = `<option>Belum ada data</option>`;
                 return;
            }

            guruNameSelect.innerHTML = data.map(g => {
                const simpleName = g.name.split(',')[0];
                return `<option value="${g.name}">${simpleName} (Walas ${g.kelas})</option>`
            }).join('');
        };

        // --- ROLE & VIEW MANAGEMENT ---
        const switchRoleView = (role) => {
            siswaSelection.classList.toggle('hidden', role !== 'siswa');
            guruSelection.classList.toggle('hidden', role !== 'guru');
            adminCredentials.classList.toggle('hidden', role !== 'admin');
            if (role === 'siswa') populateKelasSelect();
            if (role === 'guru') populateGuruSelect();
        };
        
        // --- RENDER DASHBOARDS ---
        const renderDashboard = (role, user) => {
            dashboardContent.innerHTML = '';
            let template;
            currentUser = { role, name: user };

            if (role === 'siswa') {
                currentUser.kelas = kelasSelect.value;
                template = document.getElementById('siswa-dashboard').content.cloneNode(true);
                welcomeMessage.textContent = `Selamat Datang, ${user}! üíñ (${currentUser.kelas})`;
                dashboardContent.appendChild(template);
                setupSiswaDashboard();
            } else if (role === 'guru') {
                // Fetch full guru data
                supabaseClient.from('guru').select('*').eq('name', user).single().then(({data, error}) => {
                    if (error) return showAlert("Gagal memuat data guru.");
                    currentUser.guruData = data;
                    template = document.getElementById('guru-dashboard').content.cloneNode(true);
                    const simpleName = user.split(',')[0];
                    welcomeMessage.textContent = `Selamat bertugas, ${simpleName}! üìö`;
                    template.querySelector('#guru-kelas').textContent = data.kelas;
                    template.querySelector('#guru-mapel').textContent = data.mapel;
                    dashboardContent.appendChild(template);
                    setupGuruDashboard();
                });
            } else if (role === 'admin') {
                template = document.getElementById('admin-dashboard').content.cloneNode(true);
                welcomeMessage.textContent = `Selamat datang, Admin! ‚ú® Anda memiliki akses penuh.`;
                dashboardContent.appendChild(template);
                setupAdminDashboard();
            }
            loginPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
        };

        // --- DASHBOARD SPECIFIC SETUP ---
        const setupSiswaDashboard = async () => {
            dashboardContent.querySelectorAll('.btn-absen').forEach(btn => btn.addEventListener('click', (e) => openCameraModal(e.target.dataset.type)));
            
            const absensiStatus = dashboardContent.querySelector('#absensi-status');
            const btnMasuk = dashboardContent.querySelector('#btn-absen-masuk');
            const btnPulang = dashboardContent.querySelector('#btn-absen-pulang');
            const fotoMasukImg = dashboardContent.querySelector('#fotoMasuk');
            const fotoPulangImg = dashboardContent.querySelector('#fotoPulang');
            const fotoContainer = dashboardContent.querySelector('#foto-bukti-container');

            // Check today's attendance status
            const { data, error } = await supabaseClient.from('absensi')
                .select('type, photo_url')
                .eq('user_name', currentUser.name)
                .eq('attendance_date', getTodayDate());
            
            if (error) {
                absensiStatus.textContent = 'Gagal memuat status';
            } else {
                const absenMasuk = data.find(a => a.type === 'masuk');
                const absenPulang = data.find(a => a.type === 'pulang');

                if (absenMasuk) {
                    btnMasuk.disabled = true;
                    btnPulang.disabled = false;
                    absensiStatus.textContent = 'Status: Sudah Absen Masuk';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-green-100 text-green-800';
                    fotoMasukImg.src = absenMasuk.photo_url;
                    fotoContainer.classList.remove('hidden');
                } else {
                    absensiStatus.textContent = 'Status: Belum Absen';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-slate-100';
                }

                if (absenPulang) {
                    btnPulang.disabled = true;
                    absensiStatus.textContent = 'Status: Sesi Absen Selesai';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-blue-100 text-blue-800';
                    fotoPulangImg.src = absenPulang.photo_url;
                }
            }


            dashboardContent.querySelector('#izinForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                showLoader(btn);

                const izinData = {
                    siswa_name: currentUser.name,
                    siswa_kelas: currentUser.kelas,
                    type: dashboardContent.querySelector('#izinTipe').value,
                    reason: dashboardContent.querySelector('#izinAlasan').value,
                };
                
                const fileInput = dashboardContent.querySelector('#izinFile');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const filePath = `izin/${currentUser.kelas}/${currentUser.name}-${Date.now()}`;
                    const { error: uploadError } = await supabaseClient.storage.from('uploads').upload(filePath, file);

                    if (uploadError) {
                        showAlert('Gagal mengupload file: ' + uploadError.message);
                        hideLoader(btn, originalText);
                        return;
                    }
                    
                    const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(filePath);
                    izinData.file_url = publicUrl;
                }

                const { error: insertError } = await supabaseClient.from('izin').insert(izinData);
                hideLoader(btn, originalText);
                if (insertError) {
                    showAlert('Gagal mengirim laporan: ' + insertError.message);
                } else {
                    showAlert('Laporan izin/sakit berhasil dikirim!');
                    e.target.reset();
                }
            });
        };

        const setupGuruDashboard = async () => {
            const btnMasukGuru = dashboardContent.querySelector('#btn-absen-masuk-guru');
            const absensiStatusGuru = dashboardContent.querySelector('#absensi-status-guru');
            const fotoContainerGuru = dashboardContent.querySelector('#foto-bukti-container-guru');
            const fotoMasukGuruImg = dashboardContent.querySelector('#fotoMasukGuru');

            btnMasukGuru.addEventListener('click', (e) => openCameraModal(e.target.dataset.type));

            // Check guru attendance
            const { data, error } = await supabaseClient.from('absensi').select('photo_url').eq('user_name', currentUser.name).eq('attendance_date', getTodayDate()).eq('type', 'masuk').single();

            if (data) {
                btnMasukGuru.disabled = true;
                absensiStatusGuru.textContent = 'Status: Sudah Absen Masuk';
                absensiStatusGuru.className = 'font-bold text-xl p-3 rounded-lg bg-green-100 text-green-800';
                fotoContainerGuru.classList.remove('hidden');
                fotoMasukGuruImg.src = data.photo_url;
            } else {
                absensiStatusGuru.textContent = 'Status: Belum Absen';
                absensiStatusGuru.className = 'font-bold text-xl p-3 rounded-lg bg-slate-100';
            }
            renderDaftarHadir(currentUser.guruData.kelas);
        };

        const setupAdminDashboard = async () => {
            const fetchStats = async () => {
                const today = getTodayDate();
                // Get total students and gurus
                const { count: totalSiswa } = await supabaseClient.from('siswa').select('*', { count: 'exact', head: true });
                // Get today's attendance
                const { data: absensiSiswa, error: errAbsensi } = await supabaseClient.from('absensi').select('user_name').eq('attendance_date', today).eq('user_role', 'siswa').eq('type', 'masuk');
                const { count: guruHadir } = await supabaseClient.from('absensi').select('*', { count: 'exact', head: true }).eq('attendance_date', today).eq('user_role', 'guru');
                // Get today's approved izin/sakit
                const { count: siswaIzin } = await supabaseClient.from('izin').select('*', { count: 'exact', head: true }).eq('created_at', today).eq('status', 'disetujui');
                
                const siswaHadir = absensiSiswa ? absensiSiswa.length : 0;
                const siswaAlpa = totalSiswa - siswaHadir - (siswaIzin || 0);

                const container = document.getElementById('admin-stats-container');
                container.innerHTML = `
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-2xl font-bold text-green-800">${siswaHadir}</p><p class="text-sm text-green-600">Siswa Hadir</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><p class="text-2xl font-bold text-yellow-800">${siswaIzin || 0}</p><p class="text-sm text-yellow-600">Izin/Sakit</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-2xl font-bold text-red-800">${siswaAlpa < 0 ? 0 : siswaAlpa}</p><p class="text-sm text-red-600">Siswa Alpa</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-2xl font-bold text-blue-800">${guruHadir || 0}</p><p class="text-sm text-blue-600">Guru Hadir</p></div>
                `;
            };
            
            await fetchStats();
            await renderIzinListForAdmin();

            // Real-time subscription for izin list
            supabaseClient.channel('public:izin')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'izin' }, payload => {
                    console.log('Perubahan data izin terdeteksi!', payload);
                    renderIzinListForAdmin(); // Re-render the list
                    fetchStats(); // Update stats as well
                })
                .subscribe();
        };

        const renderDaftarHadir = async (kelas) => {
            const tableBody = document.getElementById('daftarHadirSiswa');
            tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4">Memuat data...</td></tr>';
            
            // Get all students in the class
            const { data: siswaDiKelas, error: siswaError } = await supabaseClient.from('siswa').select('name').eq('kelas', kelas);
            if(siswaError) return tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4 text-red-500">Gagal memuat siswa.</td></tr>';

            // Get all attendance and izin data for today
            const today = getTodayDate();
            const { data: absensiHariIni, error: absensiError } = await supabaseClient.from('absensi').select('user_name, type').eq('attendance_date', today);
            const { data: izinHariIni, error: izinError } = await supabaseClient.from('izin').select('siswa_name, type, status').eq('created_at', today);

            if (!siswaDiKelas) return;

            let rekap = { Hadir: 0, 'Izin/Sakit': 0, Alpa: siswaDiKelas.length };
            
            tableBody.innerHTML = ''; // Clear table
            siswaDiKelas.forEach(siswa => {
                const absenMasuk = absensiHariIni?.find(a => a.user_name === siswa.name && a.type === 'masuk');
                const izinDisetujui = izinHariIni?.find(i => i.siswa_name === siswa.name && i.status === 'disetujui');
                
                let statusHtml = '';
                if(absenMasuk) {
                    statusHtml = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Hadir</span>`;
                    rekap.Hadir++;
                    rekap.Alpa--;
                } else if (izinDisetujui) {
                    statusHtml = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">${izinDisetujui.type}</span>`;
                    rekap['Izin/Sakit']++;
                    rekap.Alpa--;
                } else {
                    statusHtml = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Alpa</span>`;
                }

                const row = document.createElement('tr');
                row.className = "bg-white border-b";
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium">${siswa.name}</td>
                    <td class="px-6 py-4">${statusHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Render Rekap Kelas
            const rekapContainer = document.getElementById('rekap-kelas-content');
            rekapContainer.innerHTML = `
                <div class="bg-green-100 p-3 rounded-lg"><p class="font-bold text-green-800 text-xl">${rekap.Hadir}</p><p class="text-xs text-green-600 font-medium">Hadir</p></div>
                <div class="bg-yellow-100 p-3 rounded-lg"><p class="font-bold text-yellow-800 text-xl">${rekap['Izin/Sakit']}</p><p class="text-xs text-yellow-600 font-medium">Izin/Sakit</p></div>
                <div class="bg-red-100 p-3 rounded-lg"><p class="font-bold text-red-800 text-xl">${rekap.Alpa}</p><p class="text-xs text-red-600 font-medium">Alpa</p></div>
            `;
        };
        
        const renderIzinListForAdmin = async () => {
            const container = document.getElementById('izin-list');
            const { data, error } = await supabaseClient.from('izin').select('*').eq('status', 'pending');
            
            if (error) return container.innerHTML = `<p class="text-sm text-red-500">Gagal memuat data.</p>`;
            
            container.innerHTML = '';
            if (data.length > 0) {
                data.forEach(izin => {
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded-lg bg-slate-50';
                    card.dataset.id = izin.id;
                    card.innerHTML = `
                        <p class="font-bold">${izin.siswa_name} (${izin.siswa_kelas}) - <span class="font-normal text-sm ${izin.type === 'Sakit' ? 'text-orange-600' : 'text-blue-600'}">${izin.type}</span></p>
                        <p class="text-xs text-slate-500 mt-1">${izin.reason}</p>
                        ${izin.file_url ? `<a href="${izin.file_url}" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 block"><i class="fa fa-paperclip mr-1"></i>Lihat Surat</a>` : ''}
                        <div class="text-right mt-2 space-x-2">
                            <button class="btn-konfirmasi setujui text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-action="disetujui">Setujui</button>
                            <button class="btn-konfirmasi tolak text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-action="ditolak">Tolak</button>
                        </div>`;
                    container.appendChild(card);
                });
                container.querySelectorAll('.btn-konfirmasi').forEach(btn => btn.addEventListener('click', handleKonfirmasiIzin));
            } else {
                container.innerHTML = `<p class="text-sm text-slate-500 text-center py-4">Tidak ada pengajuan izin saat ini. üéâ</p>`;
            }
        };

        const handleKonfirmasiIzin = async (e) => {
            const btn = e.target;
            const card = btn.closest('.p-3.border');
            const id = parseInt(card.dataset.id);
            const action = btn.dataset.action;
            
            const { error } = await supabaseClient.from('izin').update({ status: action }).eq('id', id);
            
            if (error) {
                showAlert('Gagal memperbarui status: ' + error.message);
            } else {
                showAlert(`Pengajuan telah ${action}.`);
                // The real-time subscription will handle re-rendering automatically
            }
        };

        // --- CAMERA LOGIC ---
        let currentAbsenType = '';
        const openCameraModal = async (type) => {
            currentAbsenType = type;
            cameraModal.classList.remove('hidden');
            recaptureBtn.click();
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('Browser Anda tidak mendukung akses kamera.');
                closeCameraModal(); return;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                cameraFeed.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showAlert('Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.');
                closeCameraModal();
            }
        };
        const closeCameraModal = () => {
            if (stream) stream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
        };
        captureBtn.addEventListener('click', () => {
            cameraCanvas.width = cameraFeed.videoWidth;
            cameraCanvas.height = cameraFeed.videoHeight;
            const context = cameraCanvas.getContext('2d');
            context.scale(-1, 1);
            context.drawImage(cameraFeed, -cameraCanvas.width, 0, cameraCanvas.width, cameraCanvas.height);
            
            photoPreview.src = cameraCanvas.toDataURL('image/webp');
            photoPreview.classList.remove('hidden');
            cameraFeed.classList.add('hidden');
            captureBtn.classList.add('hidden');
            recaptureBtn.classList.remove('hidden');
            confirmPhotoBtn.classList.remove('hidden');
        });
        recaptureBtn.addEventListener('click', () => {
            photoPreview.classList.add('hidden');
            cameraFeed.classList.remove('hidden');
            captureBtn.classList.remove('hidden');
            recaptureBtn.classList.add('hidden');
            confirmPhotoBtn.classList.add('hidden');
        });
        confirmPhotoBtn.addEventListener('click', async () => {
            const btn = confirmPhotoBtn;
            const originalText = btn.innerHTML;
            showLoader(btn);

            const response = await fetch(photoPreview.src);
            const blob = await response.blob();
            const filePath = `absensi/${currentUser.role}/${currentUser.name}-${currentAbsenType}-${Date.now()}.webp`;

            const { error: uploadError } = await supabaseClient.storage.from('uploads').upload(filePath, blob, { contentType: 'image/webp' });
            if (uploadError) {
                showAlert('Gagal upload foto: ' + uploadError.message);
                hideLoader(btn, originalText);
                return;
            }

            const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(filePath);
            
            const attendanceData = {
                user_name: currentUser.name,
                user_role: currentUser.role,
                type: currentAbsenType,
                photo_url: publicUrl,
                attendance_date: getTodayDate()
            };

            const { error: insertError } = await supabaseClient.from('absensi').insert(attendanceData);
            hideLoader(btn, originalText);

            if (insertError) {
                showAlert('Gagal menyimpan absensi: ' + insertError.message);
            } else {
                showAlert(`Absen ${currentAbsenType} berhasil!`);
                closeCameraModal();
                // Refresh dashboard view after successful attendance
                renderDashboard(currentUser.role, currentUser.name);
            }
        });
        closeCameraBtn.addEventListener('click', closeCameraModal);
        
        // --- EVENT LISTENERS ---
        roleSelect.addEventListener('change', (e) => switchRoleView(e.target.value));
        kelasSelect.addEventListener('change', (e) => populateSiswaSelect(e.target.value));

        loginBtn.addEventListener('click', () => {
            const role = roleSelect.value;
            let user, isValid = false;

            if (role === 'admin') {
                if (document.getElementById('adminUser').value === 'admin' && document.getElementById('adminPass').value === 'admin123') { user = 'Admin'; isValid = true; } 
                else { showAlert('Username atau Password Admin salah!'); }
            } else if (role === 'siswa') { user = userNameSelect.value; isValid = true; } 
            else if (role === 'guru') { user = guruNameSelect.value; isValid = true; }

            if (isValid) renderDashboard(role, user);
        });
        
        logoutBtn.addEventListener('click', () => {
            dashboard.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
            currentUser = {};
        });

        // --- INITIALIZATION ---
        switchRoleView('siswa');
    });
    </script>
</body>
</html>

