<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Online - SMAN 1 Dramaga (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .bg-maroon-800 { background-color: #800000; }
        .bg-maroon-700 { background-color: #990000; }
        .bg-maroon-600 { background-color: #B20000; }
        .text-maroon-800 { color: #800000; }
        .border-maroon-800 { border-color: #800000; }
        .gradient-bg {
            background: linear-gradient(135deg, #4a0404, #800000);
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #800000;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #660000;
        }
        .input-field {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #800000;
            box-shadow: 0 0 0 2px rgba(128, 0, 0, 0.2);
        }
        #camera-modal video {
            width: 100%;
            border-radius: 8px;
            transform: scaleX(-1); /* Mirror effect */
        }
        #camera-modal canvas {
            display: none;
        }
        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
            margin-right: 8px;
        }
        .tab-btn.active {
            background-color: #800000;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Container Utama -->
    <div id="app" class="min-h-screen flex items-center justify-center p-4 gradient-bg">

        <!-- Halaman Login -->
        <div id="loginPage" class="w-full max-w-md">
            <div class="card p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-maroon-800">Absensi Online üè´</h1>
                    <p class="text-slate-500 mt-2 font-semibold">SMAN 1 DRAMAGA</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="role" class="block text-sm font-medium text-slate-600 mb-1">Pilih Peran Anda</label>
                        <select id="role" class="input-field bg-white">
                            <option value="siswa">Siswa</option>
                            <option value="guru">Guru</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <div id="siswaSelection" class="space-y-4">
                        <div>
                            <label for="kelasSelect" class="block text-sm font-medium text-slate-600 mb-1">Pilih Kelas</label>
                            <select id="kelasSelect" class="input-field bg-white"><option>Memuat...</option></select>
                        </div>
                         <div>
                            <label for="userName" class="block text-sm font-medium text-slate-600 mb-1">Pilih Nama Siswa</label>
                            <select id="userName" class="input-field bg-white"><option>Pilih Kelas Dulu</option></select>
                        </div>
                    </div>

                    <div id="guruSelection" class="hidden">
                        <label for="guruName" class="block text-sm font-medium text-slate-600 mb-1">Pilih Nama Anda</label>
                        <select id="guruName" class="input-field bg-white"><option>Memuat...</option></select>
                    </div>

                    <div id="adminCredentials" class="hidden space-y-4">
                        <div>
                            <label for="adminUser" class="block text-sm font-medium text-slate-600 mb-1">Username</label>
                            <input type="text" id="adminUser" class="input-field" placeholder="admin">
                        </div>
                        <div>
                            <label for="adminPass" class="block text-sm font-medium text-slate-600 mb-1">Password</label>
                            <input type="password" id="adminPass" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="loginBtn" class="btn btn-primary w-full">Login</button>
                </div>

                <div class="mt-6 text-center text-xs text-slate-400 bg-slate-50 p-3 rounded-lg">
                    <p class="font-bold">Informasi Login:</p>
                    <p><span class="font-semibold">Siswa/Guru:</span> Cukup pilih kelas dan nama.</p>
                    <p><span class="font-semibold">Admin:</span> Username: <span class="font-mono">admin</span>, Password: <span class="font-mono">admin123</span></p>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard" class="hidden w-full max-w-6xl">
            <header class="card p-4 mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-maroon-800">Dashboard Absensi üìã</h2>
                    <p id="welcomeMessage" class="text-slate-500"></p>
                </div>
                <button id="logoutBtn" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">
                    <i class="fa fa-sign-out-alt mr-2"></i>Logout
                </button>
            </header>
            <main id="dashboardContent" class="space-y-6"></main>
        </div>
    </div>
    
    <!-- TEMPLATES -->
    <template id="siswa-dashboard">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Absensi Harian Siswa üì∏</h3>
                    <div class="text-center space-y-4">
                         <p class="text-sm text-slate-500">Silakan lakukan absensi masuk atau pulang dengan foto selfie.</p>
                         <div id="absensi-status" class="font-bold text-xl p-3 rounded-lg bg-slate-100">Memeriksa...</div>
                         <div id="foto-bukti-container" class="hidden mt-4">
                            <p class="text-sm font-semibold mb-2">Bukti Foto:</p>
                            <div class="flex justify-center gap-4">
                                <div class="text-center">
                                    <p class="text-xs text-slate-500">Masuk</p>
                                    <img id="fotoMasuk" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                                </div>
                                 <div class="text-center">
                                    <p class="text-xs text-slate-500">Pulang</p>
                                    <img id="fotoPulang" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                                </div>
                            </div>
                         </div>
                         <div class="flex justify-center gap-4 mt-4">
                              <button id="btn-absen-masuk" data-type="masuk" class="btn-absen btn btn-primary w-1/2">
                                  <i class="fa fa-camera mr-2"></i>Absen Masuk
                              </button>
                              <button id="btn-absen-pulang" data-type="pulang" class="btn-absen btn bg-orange-500 text-white w-1/2 hover:bg-orange-600" disabled>
                                  <i class="fa fa-camera mr-2"></i>Absen Pulang
                              </button>
                         </div>
                         <p class="text-xs text-slate-400 mt-2">Geotagging lokasi Anda akan aktif secara otomatis.</p>
                    </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Ajukan Izin/Sakit üíå</h3>
                    <form id="izinForm" class="space-y-3">
                        <select id="izinTipe" class="input-field bg-white">
                            <option value="Izin">Izin</option>
                            <option value="Sakit">Sakit</option>
                        </select>
                        <textarea id="izinAlasan" class="input-field" rows="3" placeholder="Contoh: demam tinggi, ada surat dokter terlampir." required></textarea>
                        <div>
                            <label class="text-sm font-medium text-slate-600">Upload Surat (opsional)</label>
                            <input id="izinFile" type="file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-maroon-50 file:text-maroon-700 hover:file:bg-maroon-100 mt-1"/>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Kirim Laporan</button>
                    </form>
                </div>
            </div>
            <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Info & Riwayat üèÜ</h3>
                     <div class="text-center bg-slate-100 text-slate-800 p-4 rounded-lg">
                        <i class="fas fa-history text-3xl mb-2"></i>
                        <p class="font-bold">Riwayat Kehadiran</p>
                        <p id="riwayat-kehadiran" class="text-xs mt-2">Memuat data...</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="guru-dashboard">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                 <div class="card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold">Daftar Hadir Digital üìù - Kelas <span id="guru-kelas" class="font-semibold"></span></h3>
                            <p class="text-sm text-slate-500 mb-4">Pelajaran: <span id="guru-mapel" class="font-semibold"></span></p>
                        </div>
                    </div>
                    <div id="rekap-kelas-container" class="mb-6">
                        <h4 class="font-bold text-sm mb-2 text-slate-600">Rekap Kelas Hari Ini</h4>
                        <div id="rekap-kelas-content" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <p class="col-span-full text-slate-500">Memuat rekap...</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                                <tr>
                                    <th class="px-6 py-3">Nama Siswa</th>
                                    <th class="px-6 py-3">Status Hari Ini</th>
                                    <th class="px-6 py-3">Bukti Foto</th>
                                </tr>
                            </thead>
                            <tbody id="daftarHadirSiswa"><tr class="bg-white"><td colspan="3" class="text-center p-4">Memuat daftar siswa...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Absensi Guru üßë‚Äçüè´</h3>
                    <div class="text-center space-y-4">
                         <div id="absensi-status-guru" class="font-bold text-xl p-3 rounded-lg bg-slate-100">Memeriksa...</div>
                         <div id="foto-bukti-container-guru" class="hidden mt-4">
                             <img id="fotoMasukGuru" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200 mx-auto" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                         </div>
                         <div class="flex justify-center gap-4 mt-4">
                              <button id="btn-absen-masuk-guru" data-type="masuk" class="btn-absen-guru btn btn-primary w-full">
                                  <i class="fa fa-camera mr-2"></i>Absen Masuk
                              </button>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="admin-dashboard">
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                     <h3 class="text-lg font-bold mb-4">Monitoring Real-Time üìä</h3>
                     <div id="admin-stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Siswa Hadir</p></div>
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Siswa Izin/Sakit</p></div>
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Siswa Alpa</p></div>
                         <div class="bg-slate-100 p-4 rounded-lg"><p class="text-2xl font-bold text-slate-800">...</p><p class="text-sm text-slate-600">Guru Hadir</p></div>
                     </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Monitoring Detail Absensi Siswa</h3>
                    <div>
                        <label for="adminKelasSelect" class="block text-sm font-medium text-slate-600 mb-2">Pilih Kelas untuk Ditampilkan</label>
                        <select id="adminKelasSelect" class="input-field bg-white mb-4"><option>Memuat kelas...</option></select>
                    </div>
                     <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                                <tr>
                                    <th class="px-6 py-3">Nama Siswa</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">Bukti Foto</th>
                                </tr>
                            </thead>
                            <tbody id="adminDaftarHadirSiswa"><tr class="bg-white"><td colspan="3" class="text-center p-4 text-slate-500">Silakan pilih kelas terlebih dahulu.</td></tr></tbody>
                        </table>
                    </div>
                 </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Monitoring Absensi Guru Hari Ini üßë‚Äçüè´</h3>
                    <div id="admin-guru-attendance-list" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4">
                        <p class="col-span-full text-center text-slate-500">Memuat data absensi guru...</p>
                    </div>
                 </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Manajemen Data üóÉÔ∏è</h3>
                    <!-- Tabs -->
                    <div class="border-b border-slate-200 mb-4">
                        <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                            <button class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="siswa">Manajemen Siswa</button>
                            <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="guru">Manajemen Guru</button>
                        </nav>
                    </div>
                    <!-- Tab Content -->
                    <div id="manajemen-siswa-content" class="tab-content active">
                        <form id="addSiswaForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 p-4 bg-slate-50 rounded-lg">
                            <input type="text" id="newSiswaName" placeholder="Nama Siswa Baru" class="input-field sm:col-span-2" required>
                            <input type="text" id="newSiswaKelas" placeholder="Contoh: Kelas 12 A" class="input-field">
                            <button type="submit" class="btn btn-primary sm:col-span-3"><i class="fa fa-plus mr-2"></i>Tambah Siswa</button>
                        </form>
                        <div class="max-h-60 overflow-y-auto">
                            <table class="w-full text-sm text-left"><tbody id="siswa-management-table"></tbody></table>
                        </div>
                    </div>
                    <div id="manajemen-guru-content" class="tab-content">
                        <form id="addGuruForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 p-4 bg-slate-50 rounded-lg">
                             <input type="text" id="newGuruName" placeholder="Nama Guru Baru" class="input-field" required>
                             <input type="text" id="newGuruKelas" placeholder="Kelas Wali (Contoh: Kelas 12 A)" class="input-field">
                             <input type="text" id="newGuruMapel" placeholder="Mata Pelajaran" class="input-field sm:col-span-2">
                             <button type="submit" class="btn btn-primary sm:col-span-2"><i class="fa fa-plus mr-2"></i>Tambah Guru</button>
                        </form>
                         <div class="max-h-60 overflow-y-auto">
                            <table class="w-full text-sm text-left"><tbody id="guru-management-table"></tbody></table>
                        </div>
                    </div>
                 </div>
            </div>
            <div class="space-y-6">
                 <div class="card p-6">
                     <h3 class="text-lg font-bold mb-4">Konfirmasi Izin/Sakit Siswa ‚úÖ</h3>
                     <div id="izin-list" class="space-y-3 max-h-96 overflow-y-auto">
                        <p class="text-sm text-slate-500 text-center py-4">Memuat data izin...</p>
                     </div>
                 </div>
            </div>
       </div>
    </template>
    
    <!-- MODALS -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center card">
            <p id="alert-message" class="mb-4 text-slate-700"></p>
            <div id="alert-buttons">
                <button id="alert-ok-btn" class="btn btn-primary px-8">OK</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md card">
             <h3 id="edit-modal-title" class="text-lg font-bold mb-4">Edit Data</h3>
             <form id="edit-form" class="space-y-4"></form>
             <div class="mt-6 flex justify-end gap-3">
                 <button id="edit-cancel-btn" class="btn bg-slate-200 text-slate-700">Batal</button>
                 <button id="edit-save-btn" class="btn btn-primary">Simpan Perubahan</button>
             </div>
        </div>
    </div>


    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md card relative">
            <button id="close-camera-btn" class="absolute top-2 right-2 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            <h3 class="text-lg font-bold mb-4 text-center">Ambil Foto Selfie</h3>
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <img id="photo-preview" class="hidden w-full rounded-lg mt-4">
            <div class="mt-4 flex gap-4">
                <button id="capture-btn" class="btn btn-primary w-full"><i class="fa fa-camera mr-2"></i>Ambil Gambar</button>
                <button id="recapture-btn" class="btn bg-slate-500 text-white w-full hidden"><i class="fa fa-redo mr-2"></i>Ulangi</button>
                <button id="confirm-photo-btn" class="btn bg-green-500 text-white w-full hidden"><i class="fa fa-check mr-2"></i>Konfirmasi</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- SUPABASE SETUP ---
        // PENTING: Ganti dengan URL dan Kunci Anon dari proyek Supabase Anda!
        const SUPABASE_URL = 'https://qwjidphtepjklmpgpsai.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3amlkcGh0ZXBqa2xtcGdwc2FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5MzA1MTMsImV4cCI6MjA3NjUwNjUxM30.8WYPttRLyA0heSJRQa_kmi1L6VinWrNbZg6XQhbwsF4';
        
        // Cek jika placeholder belum diganti
        if (SUPABASE_URL.includes('URL_PROYEK_ANDA') || SUPABASE_ANON_KEY.includes('KUNCI_ANON_ANDA')) {
            document.body.innerHTML = `<div class="h-screen w-screen flex items-center justify-center bg-red-100 text-red-800 p-8"><div class="text-center">
                <h1 class="text-2xl font-bold mb-4">Konfigurasi Supabase Diperlukan!</h1>
                <p>Silakan buka file <strong>index.html</strong>, cari bagian <strong>SUPABASE SETUP</strong> di dalam tag &lt;script&gt;, dan ganti placeholder <code>SUPABASE_URL</code> dan <code>SUPABASE_ANON_KEY</code> dengan kredensial dari proyek Supabase Anda.</p>
                <p class="mt-4 text-sm">Lihat konsol browser (F12) untuk detail lebih lanjut.</p>
            </div></div>`;
            console.error("Kesalahan Konfigurasi: Anda harus mengganti placeholder SUPABASE_URL dan SUPABASE_ANON_KEY di dalam file HTML.");
            return;
        }

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabaseClient; // for debugging

        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('loginPage'), dashboard = document.getElementById('dashboard');
        const roleSelect = document.getElementById('role');
        const siswaSelection = document.getElementById('siswaSelection'), guruSelection = document.getElementById('guruSelection'), adminCredentials = document.getElementById('adminCredentials');
        const kelasSelect = document.getElementById('kelasSelect'), userNameSelect = document.getElementById('userName'), guruNameSelect = document.getElementById('guruName');
        const loginBtn = document.getElementById('loginBtn'), logoutBtn = document.getElementById('logoutBtn');
        const dashboardContent = document.getElementById('dashboardContent'), welcomeMessage = document.getElementById('welcomeMessage');
        const customAlert = document.getElementById('custom-alert'), alertMessage = document.getElementById('alert-message'), alertOkBtn = document.getElementById('alert-ok-btn'), alertButtons = document.getElementById('alert-buttons');
        const editModal = document.getElementById('edit-modal'), editModalTitle = document.getElementById('edit-modal-title'), editForm = document.getElementById('edit-form'), editCancelBtn = document.getElementById('edit-cancel-btn'), editSaveBtn = document.getElementById('edit-save-btn');
        const cameraModal = document.getElementById('camera-modal'), closeCameraBtn = document.getElementById('close-camera-btn'), cameraFeed = document.getElementById('camera-feed'), cameraCanvas = document.getElementById('camera-canvas'), captureBtn = document.getElementById('capture-btn'), photoPreview = document.getElementById('photo-preview'), recaptureBtn = document.getElementById('recapture-btn'), confirmPhotoBtn = document.getElementById('confirm-photo-btn');
        
        let stream;
        let currentUser = {};
        let currentEditData = {};

        // --- DATA SEEDING (RUNS ONCE IF DB IS EMPTY) ---
        const seedInitialData = async () => {
            console.log("Checking if initial data seeding is needed...");
            
            // Seed Gurus
            const { count: guruCount } = await supabaseClient.from('guru').select('*', { count: 'exact', head: true });
            if (guruCount === 0) {
                console.log("No teachers found, seeding teacher data...");
                const teachers = [
                    { name: 'Drs. Budi Santoso, M.Pd.', kelas: 'Kelas 12 A', mapel: 'Matematika' },
                    { name: 'Dra. Siti Aminah, S.Pd.', kelas: 'Kelas 12 B', mapel: 'Bahasa Indonesia' },
                    { name: 'Ahmad Fauzi, S.Kom.', kelas: 'Kelas 12 C', mapel: 'Fisika' },
                    { name: 'Dewi Lestari, S.S.', kelas: 'Kelas 12 D', mapel: 'Bahasa Inggris' },
                    { name: 'Eko Prasetyo, S.Pd.', kelas: 'Kelas 12 E', mapel: 'Kimia' },
                    { name: 'Fitriani, S.Ag.', kelas: 'Kelas 12 F', mapel: 'Pendidikan Agama' },
                    { name: 'Gunawan, S.Or.', kelas: 'Kelas 12 G', mapel: 'Olahraga' },
                    { name: 'Herlina, S.Pd., M.Si.', kelas: 'Kelas 12 H', mapel: 'Biologi' },
                    { name: 'Indra Wijaya, S.E.', kelas: 'Kelas 12 I', mapel: 'Ekonomi' },
                    { name: 'Joko Susilo, S.Pd.', kelas: 'Kelas 12 J', mapel: 'Sejarah' },
                    { name: 'Kartika Sari, S.Sn.', kelas: 'Kelas 12 K', mapel: 'Seni Budaya' },
                    { name: 'Linda Purnamasari, S.T.', kelas: 'Kelas 12 L', mapel: 'TIK' },
                ];
                const { error } = await supabaseClient.from('guru').insert(teachers);
                if (error) console.error("Error seeding teachers:", error);
                else console.log("Teacher data seeded successfully.");
            }

            // Seed Siswa
            const { count: siswaCount } = await supabaseClient.from('siswa').select('*', { count: 'exact', head: true });
            if (siswaCount === 0) {
                console.log("No students found, seeding student data...");
                const firstNames = ["Adinda", "Bayu", "Citra", "Dimas", "Eka", "Fajar", "Gita", "Hafiz", "Indah", "Joko", "Kevin", "Lestari", "Muhammad", "Novita", "Oscar", "Putri", "Rama", "Shinta", "Toni", "Umi"];
                const lastNames = ["Putri", "Aji", "Kirana", "Anggara", "Yulianti", "Nugroho", "Permata", "Maulana", "Sari", "Widodo", "Sanjaya", "Wulandari", "Rizky", "Ramadhani", "Wijaya", "Ayu", "Dhani", "Bella", "Firmansyah", "Kalsum"];
                const students = [];
                const kelasHuruf = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
                
                kelasHuruf.forEach(h => {
                    const namaKelas = `Kelas 12 ${h}`;
                    for(let i=0; i<10; i++){
                        const randomFirstName = firstNames[Math.floor(Math.random() * firstNames.length)];
                        const randomLastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                        // ensure unique name
                        const studentName = `${randomFirstName} ${randomLastName} ${i+1}`;
                        students.push({ name: studentName, kelas: namaKelas });
                    }
                });
                const { error } = await supabaseClient.from('siswa').insert(students);
                if (error) console.error("Error seeding students:", error);
                else console.log("Student data for 12 classes seeded successfully.");
            }
        };

        // --- HELPER FUNCTIONS ---
        const showAlert = (message) => {
            alertMessage.textContent = message;
            alertButtons.innerHTML = `<button id="alert-ok-btn" class="btn btn-primary px-8">OK</button>`;
            document.getElementById('alert-ok-btn').addEventListener('click', () => customAlert.classList.add('hidden'));
            customAlert.classList.remove('hidden');
        };

        const showConfirmation = (message, callback) => {
            alertMessage.textContent = message;
            alertButtons.innerHTML = `
                <button id="confirm-cancel" class="btn bg-slate-200 text-slate-700">Batal</button>
                <button id="confirm-ok" class="btn bg-red-600 text-white">Ya, Hapus</button>
            `;
            customAlert.classList.remove('hidden');
            document.getElementById('confirm-ok').onclick = () => {
                customAlert.classList.add('hidden');
                callback(true);
            };
             document.getElementById('confirm-cancel').onclick = () => {
                customAlert.classList.add('hidden');
                callback(false);
            };
        };

        const showLoader = (btn) => {
            btn.disabled = true;
            btn.innerHTML = `<span class="loader"></span> Memproses...`;
        };

        const hideLoader = (btn, originalText) => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        };

        const getTodayDate = () => new Date().toISOString().split('T')[0];

        // --- DATA FETCHING & POPULATION ---
        const populateKelasSelect = async () => {
            const { data, error } = await supabaseClient.from('siswa').select('kelas');
            if (error) return console.error("Gagal mengambil data kelas:", error);
            
            const kelasSet = new Set(data.map(s => s.kelas));
            const sortedKelas = Array.from(kelasSet).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
            
            if (sortedKelas.length === 0) {
                 kelasSelect.innerHTML = `<option>Belum ada data</option>`;
                 return;
            }
            
            kelasSelect.innerHTML = sortedKelas.map(k => `<option value="${k}">${k}</option>`).join('');
            await populateSiswaSelect(kelasSelect.value);
        };
        
        const populateSiswaSelect = async (kelas) => {
            userNameSelect.innerHTML = `<option>Memuat...</option>`;
            const { data, error } = await supabaseClient.from('siswa').select('name').eq('kelas', kelas);
            if (error) return console.error("Gagal mengambil data siswa:", error);
            if (data.length === 0) {
                 userNameSelect.innerHTML = `<option>Tidak ada siswa</option>`;
                 return;
            }
            userNameSelect.innerHTML = data.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        };
        
        const populateKelasSelectForAdmin = async () => {
            const adminKelasSelect = document.getElementById('adminKelasSelect');
            if (!adminKelasSelect) return;

            const { data, error } = await supabaseClient.from('siswa').select('kelas');
            if (error) return console.error("Gagal mengambil data kelas untuk admin:", error);
            
            const kelasSet = new Set(data.map(s => s.kelas));
            const sortedKelas = Array.from(kelasSet).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
            
            if (sortedKelas.length === 0) {
                 adminKelasSelect.innerHTML = `<option>Belum ada data</option>`;
                 return;
            }
            
            adminKelasSelect.innerHTML = `<option value="">-- Pilih Kelas --</option>` + sortedKelas.map(k => `<option value="${k}">${k}</option>`).join('');
        };

        const populateGuruSelect = async () => {
            const { data, error } = await supabaseClient.from('guru').select('name, kelas');
            if (error) return console.error("Gagal mengambil data guru:", error);
            
             if (data.length === 0) {
                 guruNameSelect.innerHTML = `<option>Belum ada data</option>`;
                 return;
            }

            guruNameSelect.innerHTML = data.map(g => {
                const simpleName = g.name.split(',')[0];
                return `<option value="${g.name}">${simpleName} (Walas ${g.kelas})</option>`
            }).join('');
        };

        // --- ROLE & VIEW MANAGEMENT ---
        const switchRoleView = (role) => {
            siswaSelection.classList.toggle('hidden', role !== 'siswa');
            guruSelection.classList.toggle('hidden', role !== 'guru');
            adminCredentials.classList.toggle('hidden', role !== 'admin');
            if (role === 'siswa') populateKelasSelect();
            if (role === 'guru') populateGuruSelect();
        };
        
        // --- RENDER DASHBOARDS ---
        const renderDashboard = (role, user) => {
            dashboardContent.innerHTML = '';
            let template;
            currentUser = { role, name: user };

            if (role === 'siswa') {
                currentUser.kelas = kelasSelect.value;
                template = document.getElementById('siswa-dashboard').content.cloneNode(true);
                welcomeMessage.textContent = `Selamat Datang, ${user}! üíñ (${currentUser.kelas})`;
                dashboardContent.appendChild(template);
                setupSiswaDashboard();
            } else if (role === 'guru') {
                // Fetch full guru data
                supabaseClient.from('guru').select('*').eq('name', user).single().then(({data, error}) => {
                    if (error) return showAlert("Gagal memuat data guru.");
                    currentUser.guruData = data;
                    template = document.getElementById('guru-dashboard').content.cloneNode(true);
                    const simpleName = user.split(',')[0];
                    welcomeMessage.textContent = `Selamat bertugas, ${simpleName}! üìö`;
                    template.querySelector('#guru-kelas').textContent = data.kelas;
                    template.querySelector('#guru-mapel').textContent = data.mapel;
                    dashboardContent.appendChild(template);
                    setupGuruDashboard();
                });
            } else if (role === 'admin') {
                template = document.getElementById('admin-dashboard').content.cloneNode(true);
                welcomeMessage.textContent = `Selamat datang, Admin! ‚ú® Anda memiliki akses penuh.`;
                dashboardContent.appendChild(template);
                setupAdminDashboard();
            }
            loginPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
        };

        // --- DASHBOARD SPECIFIC SETUP ---
        const setupSiswaDashboard = async () => {
            dashboardContent.querySelectorAll('.btn-absen').forEach(btn => btn.addEventListener('click', (e) => openCameraModal(e.target.dataset.type)));
            
            const absensiStatus = dashboardContent.querySelector('#absensi-status');
            const btnMasuk = dashboardContent.querySelector('#btn-absen-masuk');
            const btnPulang = dashboardContent.querySelector('#btn-absen-pulang');
            const fotoMasukImg = dashboardContent.querySelector('#fotoMasuk');
            const fotoPulangImg = dashboardContent.querySelector('#fotoPulang');
            const fotoContainer = dashboardContent.querySelector('#foto-bukti-container');

            // Check today's attendance status
            const { data, error } = await supabaseClient.from('absensi')
                .select('type, photo_url')
                .eq('user_name', currentUser.name)
                .eq('attendance_date', getTodayDate());
            
            if (error) {
                absensiStatus.textContent = 'Gagal memuat status';
            } else {
                const absenMasuk = data.find(a => a.type === 'masuk');
                const absenPulang = data.find(a => a.type === 'pulang');

                if (absenMasuk) {
                    btnMasuk.disabled = true;
                    btnPulang.disabled = false;
                    absensiStatus.textContent = 'Status: Sudah Absen Masuk';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-green-100 text-green-800';
                    fotoMasukImg.src = absenMasuk.photo_url;
                    fotoContainer.classList.remove('hidden');
                } else {
                    absensiStatus.textContent = 'Status: Belum Absen';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-slate-100';
                }

                if (absenPulang) {
                    btnPulang.disabled = true;
                    absensiStatus.textContent = 'Status: Sesi Absen Selesai';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-blue-100 text-blue-800';
                    fotoPulangImg.src = absenPulang.photo_url;
                }
            }


            dashboardContent.querySelector('#izinForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                showLoader(btn);

                const izinData = {
                    siswa_name: currentUser.name,
                    siswa_kelas: currentUser.kelas,
                    type: dashboardContent.querySelector('#izinTipe').value,
                    reason: dashboardContent.querySelector('#izinAlasan').value,
                };
                
                const fileInput = dashboardContent.querySelector('#izinFile');
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const filePath = `izin/${currentUser.kelas}/${currentUser.name}-${Date.now()}`;
                    const { error: uploadError } = await supabaseClient.storage.from('uploads').upload(filePath, file);

                    if (uploadError) {
                        showAlert('Gagal mengupload file: ' + uploadError.message);
                        hideLoader(btn, originalText);
                        return;
                    }
                    
                    const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(filePath);
                    izinData.file_url = publicUrl;
                }

                const { error: insertError } = await supabaseClient.from('izin').insert(izinData);
                hideLoader(btn, originalText);
                if (insertError) {
                    showAlert('Gagal mengirim laporan: ' + insertError.message);
                } else {
                    showAlert('Laporan izin/sakit berhasil dikirim!');
                    e.target.reset();
                }
            });
        };

        const setupGuruDashboard = async () => {
            const btnMasukGuru = dashboardContent.querySelector('#btn-absen-masuk-guru');
            const absensiStatusGuru = dashboardContent.querySelector('#absensi-status-guru');
            const fotoContainerGuru = dashboardContent.querySelector('#foto-bukti-container-guru');
            const fotoMasukGuruImg = dashboardContent.querySelector('#fotoMasukGuru');

            btnMasukGuru.addEventListener('click', (e) => openCameraModal(e.target.dataset.type));

            // Check guru attendance
            const { data, error } = await supabaseClient.from('absensi').select('photo_url').eq('user_name', currentUser.name).eq('attendance_date', getTodayDate()).eq('type', 'masuk').single();

            if (data) {
                btnMasukGuru.disabled = true;
                absensiStatusGuru.textContent = 'Status: Sudah Absen Masuk';
                absensiStatusGuru.className = 'font-bold text-xl p-3 rounded-lg bg-green-100 text-green-800';
                fotoContainerGuru.classList.remove('hidden');
                fotoMasukGuruImg.src = data.photo_url;
            } else {
                absensiStatusGuru.textContent = 'Status: Belum Absen';
                absensiStatusGuru.className = 'font-bold text-xl p-3 rounded-lg bg-slate-100';
            }
            renderDaftarHadir(currentUser.guruData.kelas, 'daftarHadirSiswa', 'rekap-kelas-content');
        };

        const setupAdminDashboard = async () => {
            const fetchStats = async () => {
                const today = getTodayDate();
                // Get total students and gurus
                const { count: totalSiswa } = await supabaseClient.from('siswa').select('*', { count: 'exact', head: true });
                // Get today's attendance
                const { data: absensiSiswa, error: errAbsensi } = await supabaseClient.from('absensi').select('user_name').eq('attendance_date', today).eq('user_role', 'siswa').eq('type', 'masuk');
                const { count: guruHadir } = await supabaseClient.from('absensi').select('*', { count: 'exact', head: true }).eq('attendance_date', today).eq('user_role', 'guru');
                // Get today's approved izin/sakit
                const { count: siswaIzin } = await supabaseClient.from('izin').select('*', { count: 'exact', head: true }).eq('created_at', today).eq('status', 'disetujui');
                
                const siswaHadir = absensiSiswa ? absensiSiswa.length : 0;
                const siswaAlpa = totalSiswa - siswaHadir - (siswaIzin || 0);

                const container = document.getElementById('admin-stats-container');
                container.innerHTML = `
                    <div class="bg-green-100 p-4 rounded-lg"><p class="text-2xl font-bold text-green-800">${siswaHadir}</p><p class="text-sm text-green-600">Siswa Hadir</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg"><p class="text-2xl font-bold text-yellow-800">${siswaIzin || 0}</p><p class="text-sm text-yellow-600">Izin/Sakit</p></div>
                    <div class="bg-red-100 p-4 rounded-lg"><p class="text-2xl font-bold text-red-800">${siswaAlpa < 0 ? 0 : siswaAlpa}</p><p class="text-sm text-red-600">Siswa Alpa</p></div>
                    <div class="bg-blue-100 p-4 rounded-lg"><p class="text-2xl font-bold text-blue-800">${guruHadir || 0}</p><p class="text-sm text-blue-600">Guru Hadir</p></div>
                `;
            };
            
            await fetchStats();
            await renderIzinListForAdmin();
            await renderGuruAttendanceForAdmin();
            await populateKelasSelectForAdmin();
            await setupManajemenData();

            const adminKelasSelect = document.getElementById('adminKelasSelect');
            adminKelasSelect.addEventListener('change', (e) => {
                const kelas = e.target.value;
                if (kelas) {
                    renderDaftarHadir(kelas, 'adminDaftarHadirSiswa');
                } else {
                    document.getElementById('adminDaftarHadirSiswa').innerHTML = `<tr class="bg-white"><td colspan="3" class="text-center p-4 text-slate-500">Silakan pilih kelas terlebih dahulu.</td></tr>`;
                }
            });

            // Real-time subscriptions
            supabaseClient.channel('public:izin')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'izin' }, () => { renderIzinListForAdmin(); fetchStats(); })
                .subscribe();
            
            supabaseClient.channel('public:absensi')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'absensi' }, payload => {
                    if (payload.new.user_role === 'guru') {
                        renderGuruAttendanceForAdmin();
                        fetchStats();
                    }
                })
                .subscribe();
        };

        const renderDaftarHadir = async (kelas, tableBodyId, rekapContainerId = null) => {
            const tableBody = document.getElementById(tableBodyId);
            tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4">Memuat data...</td></tr>`;
            
            // Get all students in the class
            const { data: siswaDiKelas, error: siswaError } = await supabaseClient.from('siswa').select('name').eq('kelas', kelas);
            if(siswaError) return tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-500">Gagal memuat siswa.</td></tr>`;

            // Get all attendance and izin data for today
            const today = getTodayDate();
            const { data: absensiHariIni, error: absensiError } = await supabaseClient.from('absensi').select('user_name, type, photo_url').eq('attendance_date', today);
            const { data: izinHariIni, error: izinError } = await supabaseClient.from('izin').select('siswa_name, type, status').eq('created_at', today);

            if (!siswaDiKelas) return tableBody.innerHTML = `<tr><td colspan="3" class="text-center p-4">Tidak ada siswa di kelas ini.</td></tr>`;

            let rekap = { Hadir: 0, 'Izin/Sakit': 0, Alpa: siswaDiKelas.length };
            
            tableBody.innerHTML = ''; // Clear table
            for (const siswa of siswaDiKelas) {
                const absenMasuk = absensiHariIni?.find(a => a.user_name === siswa.name && a.type === 'masuk');
                const absenPulang = absensiHariIni?.find(a => a.user_name === siswa.name && a.type === 'pulang');
                const izinDisetujui = izinHariIni?.find(i => i.siswa_name === siswa.name && i.status === 'disetujui');
                
                let statusHtml = '';
                if(absenMasuk) {
                    statusHtml = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Hadir</span>`;
                    rekap.Hadir++;
                    rekap.Alpa--;
                } else if (izinDisetujui) {
                    statusHtml = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">${izinDisetujui.type}</span>`;
                    rekap['Izin/Sakit']++;
                    rekap.Alpa--;
                } else {
                    statusHtml = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Alpa</span>`;
                }

                const photoMasukUrl = absenMasuk?.photo_url || 'https://placehold.co/40x40/e2e8f0/475569?text=M';
                const photoPulangUrl = absenPulang?.photo_url || 'https://placehold.co/40x40/e2e8f0/475569?text=P';

                const row = document.createElement('tr');
                row.className = "bg-white border-b";
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium">${siswa.name}</td>
                    <td class="px-6 py-4">${statusHtml}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                             <a href="${photoMasukUrl}" target="_blank" title="Foto Masuk">
                                <img src="${photoMasukUrl}" class="w-10 h-10 rounded-md object-cover border-2 border-slate-200 hover:border-maroon-800 transition">
                             </a>
                             <a href="${photoPulangUrl}" target="_blank" title="Foto Pulang">
                                <img src="${photoPulangUrl}" class="w-10 h-10 rounded-md object-cover border-2 border-slate-200 hover:border-maroon-800 transition">
                             </a>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            }
            
            // Render Rekap Kelas if container exists
            if (rekapContainerId) {
                const rekapContainer = document.getElementById(rekapContainerId);
                rekapContainer.innerHTML = `
                    <div class="bg-green-100 p-3 rounded-lg"><p class="font-bold text-green-800 text-xl">${rekap.Hadir}</p><p class="text-xs text-green-600 font-medium">Hadir</p></div>
                    <div class="bg-yellow-100 p-3 rounded-lg"><p class="font-bold text-yellow-800 text-xl">${rekap['Izin/Sakit']}</p><p class="text-xs text-yellow-600 font-medium">Izin/Sakit</p></div>
                    <div class="bg-red-100 p-3 rounded-lg"><p class="font-bold text-red-800 text-xl">${rekap.Alpa}</p><p class="text-xs text-red-600 font-medium">Alpa</p></div>
                `;
            }
        };
        
        const renderIzinListForAdmin = async () => {
            const container = document.getElementById('izin-list');
            const { data, error } = await supabaseClient.from('izin').select('*').eq('status', 'pending');
            
            if (error) return container.innerHTML = `<p class="text-sm text-red-500">Gagal memuat data.</p>`;
            
            container.innerHTML = '';
            if (data.length > 0) {
                data.forEach(izin => {
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded-lg bg-slate-50';
                    card.dataset.id = izin.id;
                    card.innerHTML = `
                        <p class="font-bold">${izin.siswa_name} (${izin.siswa_kelas}) - <span class="font-normal text-sm ${izin.type === 'Sakit' ? 'text-orange-600' : 'text-blue-600'}">${izin.type}</span></p>
                        <p class="text-xs text-slate-500 mt-1">${izin.reason}</p>
                        ${izin.file_url ? `<a href="${izin.file_url}" target="_blank" class="text-xs text-blue-500 hover:underline mt-1 block"><i class="fa fa-paperclip mr-1"></i>Lihat Surat</a>` : ''}
                        <div class="text-right mt-2 space-x-2">
                            <button class="btn-konfirmasi setujui text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-action="disetujui">Setujui</button>
                            <button class="btn-konfirmasi tolak text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-action="ditolak">Tolak</button>
                        </div>`;
                    container.appendChild(card);
                });
                container.querySelectorAll('.btn-konfirmasi').forEach(btn => btn.addEventListener('click', handleKonfirmasiIzin));
            } else {
                container.innerHTML = `<p class="text-sm text-slate-500 text-center py-4">Tidak ada pengajuan izin saat ini. üéâ</p>`;
            }
        };
        
        const renderGuruAttendanceForAdmin = async () => {
            const container = document.getElementById('admin-guru-attendance-list');
            if (!container) return;
            
            const { data, error } = await supabaseClient.from('absensi').select('user_name, photo_url')
                .eq('attendance_date', getTodayDate())
                .eq('user_role', 'guru')
                .eq('type', 'masuk');

            if (error) {
                container.innerHTML = `<p class="col-span-full text-center text-red-500">Gagal memuat data guru.</p>`;
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-slate-500">Belum ada guru yang absen hari ini.</p>`;
                return;
            }

            container.innerHTML = data.map(guru => `
                <div class="text-center">
                    <a href="${guru.photo_url}" target="_blank">
                        <img src="${guru.photo_url}" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200 hover:border-maroon-800 transition mx-auto" alt="Foto absen ${guru.user_name}">
                    </a>
                    <p class="text-xs font-semibold mt-1 text-slate-700">${guru.user_name.split(',')[0]}</p>
                </div>
            `).join('');
        };


        const handleKonfirmasiIzin = async (e) => {
            const btn = e.target;
            const card = btn.closest('.p-3.border');
            const id = parseInt(card.dataset.id);
            const action = btn.dataset.action;
            
            const { error } = await supabaseClient.from('izin').update({ status: action }).eq('id', id);
            
            if (error) {
                showAlert('Gagal memperbarui status: ' + error.message);
            } else {
                showAlert(`Pengajuan telah ${action}.`);
                // The real-time subscription will handle re-rendering automatically
            }
        };
        
        // --- MANAJEMEN DATA (ADMIN) ---
        const setupManajemenData = async () => {
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(`manajemen-${tab.dataset.tab}-content`).classList.add('active');
                });
            });

            // Siswa Management
            const addSiswaForm = document.getElementById('addSiswaForm');
            addSiswaForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = btn.innerHTML;
                showLoader(btn);
                const name = document.getElementById('newSiswaName').value;
                const kelas = document.getElementById('newSiswaKelas').value;
                const { error } = await supabaseClient.from('siswa').insert({ name, kelas });
                hideLoader(btn, originalText);
                if (error) showAlert('Gagal menambah siswa: ' + error.message);
                else {
                    showAlert('Siswa berhasil ditambahkan!');
                    addSiswaForm.reset();
                    // Real-time will update the table
                }
            });

            // Guru Management
            const addGuruForm = document.getElementById('addGuruForm');
            addGuruForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = btn.innerHTML;
                showLoader(btn);
                const name = document.getElementById('newGuruName').value;
                const kelas = document.getElementById('newGuruKelas').value;
                const mapel = document.getElementById('newGuruMapel').value;
                const { error } = await supabaseClient.from('guru').insert({ name, kelas, mapel });
                hideLoader(btn, originalText);
                if (error) showAlert('Gagal menambah guru: ' + error.message);
                else {
                    showAlert('Guru berhasil ditambahkan!');
                    addGuruForm.reset();
                }
            });
            
            renderSiswaManagementTable();
            renderGuruManagementTable();
            
            // Listen to changes
            supabaseClient.channel('public:siswa').on('postgres_changes', { event: '*', schema: 'public', table: 'siswa' }, renderSiswaManagementTable).subscribe();
            supabaseClient.channel('public:guru').on('postgres_changes', { event: '*', schema: 'public', table: 'guru' }, renderGuruManagementTable).subscribe();
        };

        const renderSiswaManagementTable = async () => {
            const tableBody = document.getElementById('siswa-management-table');
            const { data, error } = await supabaseClient.from('siswa').select('*');
            if(error) return tableBody.innerHTML = '<tr><td class="text-red-500">Gagal memuat</td></tr>';
            tableBody.innerHTML = data.map(siswa => `
                <tr class="border-b">
                    <td class="p-2 font-medium">${siswa.name}</td>
                    <td class="p-2 text-slate-600">${siswa.kelas}</td>
                    <td class="p-2 text-right">
                        <button class="edit-btn text-blue-600 hover:text-blue-800 mr-2" data-type="siswa" data-id="${siswa.id}"><i class="fa fa-edit"></i></button>
                        <button class="delete-btn text-red-600 hover:text-red-800" data-type="siswa" data-id="${siswa.id}"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            tableBody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
            tableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
        };
        
        const renderGuruManagementTable = async () => {
             const tableBody = document.getElementById('guru-management-table');
            const { data, error } = await supabaseClient.from('guru').select('*');
            if(error) return tableBody.innerHTML = '<tr><td class="text-red-500">Gagal memuat</td></tr>';
            tableBody.innerHTML = data.map(guru => `
                <tr class="border-b">
                    <td class="p-2 font-medium">${guru.name}</td>
                    <td class="p-2 text-slate-600">${guru.kelas} / ${guru.mapel}</td>
                    <td class="p-2 text-right">
                        <button class="edit-btn text-blue-600 hover:text-blue-800 mr-2" data-type="guru" data-id="${guru.id}"><i class="fa fa-edit"></i></button>
                        <button class="delete-btn text-red-600 hover:text-red-800" data-type="guru" data-id="${guru.id}"><i class="fa fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            
            tableBody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEdit));
            tableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDelete));
        };
        
        const handleEdit = async (e) => {
            const btn = e.currentTarget;
            const type = btn.dataset.type;
            const id = btn.dataset.id;
            
            const { data, error } = await supabaseClient.from(type).select('*').eq('id', id).single();
            if (error) return showAlert('Gagal mengambil data untuk diedit.');

            currentEditData = { type, id, data };
            editModalTitle.textContent = `Edit Data ${type.charAt(0).toUpperCase() + type.slice(1)}`;

            if (type === 'siswa') {
                editForm.innerHTML = `
                    <div><label class="block text-sm">Nama Siswa</label><input type="text" id="edit-name" class="input-field" value="${data.name}"></div>
                    <div><label class="block text-sm">Kelas</label><input type="text" id="edit-kelas" class="input-field" value="${data.kelas}"></div>
                `;
            } else if (type === 'guru') {
                editForm.innerHTML = `
                    <div><label class="block text-sm">Nama Guru</label><input type="text" id="edit-name" class="input-field" value="${data.name}"></div>
                    <div><label class="block text-sm">Kelas Wali</label><input type="text" id="edit-kelas" class="input-field" value="${data.kelas}"></div>
                    <div><label class="block text-sm">Mata Pelajaran</label><input type="text" id="edit-mapel" class="input-field" value="${data.mapel}"></div>
                `;
            }

            editModal.classList.remove('hidden');
        };

        const handleDelete = (e) => {
            const btn = e.currentTarget;
            const type = btn.dataset.type; // 'siswa' or 'guru'
            const id = btn.dataset.id;
            
            showConfirmation(`Anda yakin ingin menghapus data ${type} ini? Tindakan ini tidak dapat dibatalkan.`, async (isConfirmed) => {
                if(isConfirmed) {
                     const { error } = await supabaseClient.from(type).delete().eq('id', id);
                     if (error) showAlert(`Gagal menghapus: ${error.message}`);
                     else showAlert(`Data ${type} berhasil dihapus.`);
                }
            });
        };

        editSaveBtn.addEventListener('click', async () => {
            const { type, id } = currentEditData;
            let updatedData = {};
            
            if (type === 'siswa') {
                updatedData = {
                    name: document.getElementById('edit-name').value,
                    kelas: document.getElementById('edit-kelas').value
                };
            } else if (type === 'guru') {
                 updatedData = {
                    name: document.getElementById('edit-name').value,
                    kelas: document.getElementById('edit-kelas').value,
                    mapel: document.getElementById('edit-mapel').value
                };
            }

            const { error } = await supabaseClient.from(type).update(updatedData).eq('id', id);
            if (error) {
                showAlert('Gagal menyimpan perubahan: ' + error.message);
            } else {
                showAlert('Data berhasil diperbarui!');
                editModal.classList.add('hidden');
            }
        });
        editCancelBtn.addEventListener('click', () => editModal.classList.add('hidden'));


        // --- CAMERA LOGIC ---
        let currentAbsenType = '';
        const openCameraModal = async (type) => {
            currentAbsenType = type;
            cameraModal.classList.remove('hidden');
            recaptureBtn.click();
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('Browser Anda tidak mendukung akses kamera.');
                closeCameraModal(); return;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                cameraFeed.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                showAlert('Tidak dapat mengakses kamera. Pastikan Anda memberikan izin.');
                closeCameraModal();
            }
        };
        const closeCameraModal = () => {
            if (stream) stream.getTracks().forEach(track => track.stop());
            cameraModal.classList.add('hidden');
        };
        captureBtn.addEventListener('click', () => {
            cameraCanvas.width = cameraFeed.videoWidth;
            cameraCanvas.height = cameraFeed.videoHeight;
            const context = cameraCanvas.getContext('2d');
            context.scale(-1, 1);
            context.drawImage(cameraFeed, -cameraCanvas.width, 0, cameraCanvas.width, cameraCanvas.height);
            
            photoPreview.src = cameraCanvas.toDataURL('image/webp');
            photoPreview.classList.remove('hidden');
            cameraFeed.classList.add('hidden');
            captureBtn.classList.add('hidden');
            recaptureBtn.classList.remove('hidden');
            confirmPhotoBtn.classList.remove('hidden');
        });
        recaptureBtn.addEventListener('click', () => {
            photoPreview.classList.add('hidden');
            cameraFeed.classList.remove('hidden');
            captureBtn.classList.remove('hidden');
            recaptureBtn.classList.add('hidden');
            confirmPhotoBtn.classList.add('hidden');
        });
        confirmPhotoBtn.addEventListener('click', async () => {
            const btn = confirmPhotoBtn;
            const originalText = btn.innerHTML;
            showLoader(btn);

            const response = await fetch(photoPreview.src);
            const blob = await response.blob();
            const filePath = `absensi/${currentUser.role}/${currentUser.name}-${currentAbsenType}-${Date.now()}.webp`;

            const { error: uploadError } = await supabaseClient.storage.from('uploads').upload(filePath, blob, { contentType: 'image/webp' });
            if (uploadError) {
                showAlert('Gagal upload foto: ' + uploadError.message);
                hideLoader(btn, originalText);
                return;
            }

            const { data: { publicUrl } } = supabaseClient.storage.from('uploads').getPublicUrl(filePath);
            
            const attendanceData = {
                user_name: currentUser.name,
                user_role: currentUser.role,
                type: currentAbsenType,
                photo_url: publicUrl,
                attendance_date: getTodayDate()
            };

            const { error: insertError } = await supabaseClient.from('absensi').insert(attendanceData);
            hideLoader(btn, originalText);

            if (insertError) {
                showAlert('Gagal menyimpan absensi: ' + insertError.message);
            } else {
                showAlert(`Absen ${currentAbsenType} berhasil!`);
                closeCameraModal();
                // Refresh dashboard view after successful attendance
                renderDashboard(currentUser.role, currentUser.name);
            }
        });
        closeCameraBtn.addEventListener('click', closeCameraModal);
        
        // --- EVENT LISTENERS ---
        roleSelect.addEventListener('change', (e) => switchRoleView(e.target.value));
        kelasSelect.addEventListener('change', (e) => populateSiswaSelect(e.target.value));

        loginBtn.addEventListener('click', () => {
            const role = roleSelect.value;
            let user, isValid = false;

            if (role === 'admin') {
                if (document.getElementById('adminUser').value === 'admin' && document.getElementById('adminPass').value === 'admin123') { user = 'Admin'; isValid = true; } 
                else { showAlert('Username atau Password Admin salah!'); }
            } else if (role === 'siswa') { user = userNameSelect.value; isValid = true; } 
            else if (role === 'guru') { user = guruNameSelect.value; isValid = true; }

            if (isValid) renderDashboard(role, user);
        });
        
        logoutBtn.addEventListener('click', () => {
            dashboard.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
            currentUser = {};
        });

        // --- INITIALIZATION ---
        await seedInitialData();
        switchRoleView('siswa');
    });
    </script>
</body>
</html>

