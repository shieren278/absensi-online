<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Online - SMAN 1 Dramaga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .bg-maroon-800 { background-color: #800000; }
        .bg-maroon-700 { background-color: #990000; }
        .bg-maroon-600 { background-color: #B20000; }
        .text-maroon-800 { color: #800000; }
        .border-maroon-800 { border-color: #800000; }
        .gradient-bg {
            background: linear-gradient(135deg, #4a0404, #800000);
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #800000;
            color: white;
        }
        .btn-primary:hover {
            background-color: #660000;
        }
        .input-field {
            border-radius: 8px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.3s ease;
        }
        .input-field:focus {
            outline: none;
            border-color: #800000;
            box-shadow: 0 0 0 2px rgba(128, 0, 0, 0.2);
        }
        /* Styling untuk modal kamera */
        #camera-modal video {
            width: 100%;
            border-radius: 8px;
            transform: scaleX(-1); /* Mirror effect */
        }
        #camera-modal canvas {
            display: none; /* Canvas disembunyikan */
        }
        /* New Chat styles */
        .chat-bg {
            background-color: #e5ddd5;
            background-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg'); /* Subtle WhatsApp-like pattern */
        }
        .chat-bubble {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        .chat-bubble-sent {
            background-color: #dcf8c6;
            align-self: flex-end;
        }
        .chat-bubble-received {
            background-color: #ffffff;
            align-self: flex-start;
        }
        .chat-timestamp {
            font-size: 0.65rem;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
    </style>
</head>
<body class="antialiased text-slate-800">

    <!-- Container Utama -->
    <div id="app" class="min-h-screen flex items-center justify-center p-4 gradient-bg">

        <!-- Halaman Login -->
        <div id="loginPage" class="w-full max-w-md">
            <div class="card p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-maroon-800">Absensi Online üè´</h1>
                    <p class="text-slate-500 mt-2 font-semibold">SMAN 1 DRAMAGA</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="role" class="block text-sm font-medium text-slate-600 mb-1">Pilih Peran Anda</label>
                        <select id="role" class="input-field bg-white">
                            <option value="siswa">Siswa</option>
                            <option value="guru">Guru</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>

                    <!-- Input untuk Siswa -->
                    <div id="siswaSelection" class="space-y-4">
                        <div>
                            <label for="kelasSelect" class="block text-sm font-medium text-slate-600 mb-1">Pilih Kelas</label>
                            <select id="kelasSelect" class="input-field bg-white"></select>
                        </div>
                         <div>
                            <label for="userName" class="block text-sm font-medium text-slate-600 mb-1">Pilih Nama Siswa</label>
                            <select id="userName" class="input-field bg-white"></select>
                        </div>
                    </div>

                    <!-- Input untuk Guru -->
                    <div id="guruSelection" class="hidden">
                        <label for="guruName" class="block text-sm font-medium text-slate-600 mb-1">Pilih Nama Anda</label>
                        <select id="guruName" class="input-field bg-white"></select>
                    </div>

                    <!-- Input untuk Admin -->
                    <div id="adminCredentials" class="hidden space-y-4">
                        <div>
                            <label for="adminUser" class="block text-sm font-medium text-slate-600 mb-1">Username</label>
                            <input type="text" id="adminUser" class="input-field" placeholder="admin">
                        </div>
                        <div>
                            <label for="adminPass" class="block text-sm font-medium text-slate-600 mb-1">Password</label>
                            <input type="password" id="adminPass" class="input-field" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="loginBtn" class="btn btn-primary w-full">Login</button>
                </div>

                <div class="mt-6 text-center text-xs text-slate-400 bg-slate-50 p-3 rounded-lg">
                    <p class="font-bold">Informasi Login:</p>
                    <p><span class="font-semibold">Siswa/Guru:</span> Cukup pilih kelas dan nama.</p>
                    <p><span class="font-semibold">Admin:</span> Username: <span class="font-mono">admin</span>, Password: <span class="font-mono">admin123</span></p>
                </div>
            </div>
        </div>

        <!-- Dashboard Container -->
        <div id="dashboard" class="hidden w-full max-w-6xl">
            <header class="card p-4 mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-maroon-800">Dashboard Absensi üìã</h2>
                    <p id="welcomeMessage" class="text-slate-500"></p>
                </div>
                <button id="logoutBtn" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">
                    <i class="fa fa-sign-out-alt mr-2"></i>Logout
                </button>
            </header>
            <main id="dashboardContent" class="space-y-6"></main>
        </div>
    </div>
    
    <!-- TEMPLATES -->
    <template id="siswa-dashboard">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="md:col-span-2 space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Absensi Harian Siswa üì∏</h3>
                    <div class="text-center space-y-4">
                         <p class="text-sm text-slate-500">Silakan lakukan absensi masuk atau pulang dengan foto selfie.</p>
                         <div id="absensi-status" class="font-bold text-xl p-3 rounded-lg bg-slate-100">Status: Belum Absen</div>
                         <div id="foto-bukti-container" class="hidden mt-4">
                            <p class="text-sm font-semibold mb-2">Bukti Foto:</p>
                            <div class="flex justify-center gap-4">
                                <div class="text-center">
                                    <p class="text-xs text-slate-500">Masuk</p>
                                    <img id="fotoMasuk" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                                </div>
                                 <div class="text-center">
                                    <p class="text-xs text-slate-500">Pulang</p>
                                    <img id="fotoPulang" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                                </div>
                            </div>
                         </div>
                         <div class="flex justify-center gap-4 mt-4">
                              <button data-type="masuk" class="btn-absen btn btn-primary w-1/2">
                                  <i class="fa fa-camera mr-2"></i>Absen Masuk
                              </button>
                              <button data-type="pulang" class="btn-absen btn bg-orange-500 text-white w-1/2 hover:bg-orange-600" disabled>
                                  <i class="fa fa-camera mr-2"></i>Absen Pulang
                              </button>
                         </div>
                         <p class="text-xs text-slate-400 mt-2">Geotagging lokasi Anda akan aktif secara otomatis.</p>
                    </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Ajukan Izin/Sakit üíå</h3>
                    <form id="izinForm" class="space-y-3">
                        <select id="izinTipe" class="input-field bg-white">
                            <option value="Izin">Izin</option>
                            <option value="Sakit">Sakit</option>
                        </select>
                        <textarea id="izinAlasan" class="input-field" rows="3" placeholder="Contoh: demam tinggi, ada surat dokter terlampir." required></textarea>
                        <div>
                            <label class="text-sm font-medium text-slate-600">Upload Surat (opsional)</label>
                            <input id="izinFile" type="file" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-maroon-50 file:text-maroon-700 hover:file:bg-maroon-100 mt-1"/>
                        </div>
                        <button type="submit" class="btn btn-primary w-full">Kirim Laporan ke Wali Kelas</button>
                    </form>
                </div>
            </div>
            <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Info & Riwayat üèÜ</h3>
                     <div class="text-center bg-green-100 text-green-800 p-4 rounded-lg">
                        <i class="fas fa-award text-3xl mb-2"></i>
                        <p class="font-bold">Hadir 15 Hari Berturut-turut!</p>
                        <p class="text-xs">Badge "Siswa Rajin"</p>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="guru-dashboard">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                 <div class="card p-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold">Daftar Hadir Digital üìù - Kelas <span id="guru-kelas" class="font-semibold"></span></h3>
                            <p class="text-sm text-slate-500 mb-4">Pelajaran: <span id="guru-mapel" class="font-semibold"></span></p>
                        </div>
                    </div>
                    <!-- NEW: Rekap Kelas -->
                    <div id="rekap-kelas-container" class="mb-6">
                        <h4 class="font-bold text-sm mb-2 text-slate-600">Rekap Kelas Hari Ini</h4>
                        <div id="rekap-kelas-content" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <!-- Content generated by JS -->
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-xs text-slate-700 uppercase">
                                <tr>
                                    <th class="px-6 py-3">Nama Siswa</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">Info Izin</th>
                                    <th class="px-6 py-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="daftarHadirSiswa"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4 border-b pb-2">Absensi Guru üßë‚Äçüè´</h3>
                    <div class="text-center space-y-4">
                         <div id="absensi-status-guru" class="font-bold text-xl p-3 rounded-lg bg-slate-100">Status: Belum Absen</div>
                         <div id="foto-bukti-container-guru" class="hidden mt-4">
                             <img id="fotoMasukGuru" class="w-24 h-24 rounded-lg object-cover border-2 border-slate-200 mx-auto" src="https://placehold.co/96x96/e2e8f0/475569?text=Belum+Ada">
                         </div>
                         <div class="flex justify-center gap-4 mt-4">
                              <button data-type="masuk" class="btn-absen-guru btn btn-primary w-full">
                                  <i class="fa fa-camera mr-2"></i>Absen Masuk
                              </button>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
    <template id="admin-dashboard">
       <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                     <h3 class="text-lg font-bold mb-4">Monitoring Real-Time üìä</h3>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                         <!-- UPDATED: Made these clickable -->
                         <div data-type="siswa-hadir" class="admin-stat-card bg-green-100 p-4 rounded-lg cursor-pointer hover:bg-green-200 transition-colors"><p class="text-2xl font-bold text-green-800">125</p><p class="text-sm text-green-600">Siswa Hadir</p></div>
                         <div data-type="siswa-terlambat" class="admin-stat-card bg-yellow-100 p-4 rounded-lg cursor-pointer hover:bg-yellow-200 transition-colors"><p class="text-2xl font-bold text-yellow-800">5</p><p class="text-sm text-yellow-600">Siswa Terlambat</p></div>
                         <div data-type="siswa-alpa" class="admin-stat-card bg-red-100 p-4 rounded-lg cursor-pointer hover:bg-red-200 transition-colors"><p class="text-2xl font-bold text-red-800">2</p><p class="text-sm text-red-600">Siswa Alpa</p></div>
                         <div data-type="guru-hadir" class="admin-stat-card bg-blue-100 p-4 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors"><p class="text-2xl font-bold text-blue-800">10</p><p class="text-sm text-blue-600">Guru Hadir</p></div>
                     </div>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-bold mb-4">Rekap Laporan Bulanan üìÇ</h3>
                     <p class="text-sm text-slate-500 mb-4">Generate laporan kehadiran bulanan.</p>
                     <div class="flex gap-4">
                         <button class="btn bg-red-600 text-white flex-1 hover:bg-red-700"><i class="fa fa-file-pdf mr-2"></i>Download PDF</button>
                         <button class="btn bg-green-600 text-white flex-1 hover:bg-green-700"><i class="fa fa-file-excel mr-2"></i>Download Excel</button>
                     </div>
                 </div>
            </div>
            <div class="space-y-6">
                 <div class="card p-6">
                     <h3 class="text-lg font-bold mb-4">Konfirmasi Izin/Sakit Siswa ‚úÖ</h3>
                     <div id="izin-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                 </div>
            </div>
       </div>
    </template>
    
    <!-- MODALS -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm text-center card">
            <p id="alert-message" class="mb-4 text-slate-700"></p>
            <button id="alert-ok-btn" class="btn btn-primary px-8">OK</button>
        </div>
    </div>

    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md card relative">
            <button id="close-camera-btn" class="absolute top-2 right-2 text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            <h3 class="text-lg font-bold mb-4 text-center">Ambil Foto Selfie</h3>
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <img id="photo-preview" class="hidden w-full rounded-lg mt-4">
            <div class="mt-4 flex gap-4">
                <button id="capture-btn" class="btn btn-primary w-full"><i class="fa fa-camera mr-2"></i>Ambil Gambar</button>
                <button id="recapture-btn" class="btn bg-slate-500 text-white w-full hidden"><i class="fa fa-redo mr-2"></i>Ulangi</button>
                <button id="confirm-photo-btn" class="btn bg-green-500 text-white w-full hidden"><i class="fa fa-check mr-2"></i>Konfirmasi</button>
            </div>
        </div>
    </div>
    
    <div id="chat-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg w-full max-w-lg card flex flex-col h-[80vh]">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 class="font-bold text-maroon-800">Percakapan dengan Ortu <span id="chat-student-name"></span></h3>
                <button id="close-chat-btn" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto chat-bg flex flex-col space-y-4">
                <!-- Chat messages will be appended here -->
            </div>
            <div class="p-4 border-t bg-white rounded-b-lg">
                <div class="flex gap-2">
                    <input type="text" id="chat-input" placeholder="Ketik balasan..." class="input-field flex-1">
                    <button id="send-chat-btn" class="btn btn-primary"><i class="fa fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Detail Modal for Admin -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg card flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="detail-modal-title" class="font-bold text-maroon-800 text-xl"></h3>
                <button id="close-detail-modal" class="text-slate-500 hover:text-slate-800 text-2xl">&times;</button>
            </div>
            <div id="detail-modal-content" class="overflow-y-auto space-y-2">
                <!-- Detail list will be injected here -->
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM ELEMENTS ---
        const loginPage = document.getElementById('loginPage'), dashboard = document.getElementById('dashboard');
        const roleSelect = document.getElementById('role');
        const siswaSelection = document.getElementById('siswaSelection'), guruSelection = document.getElementById('guruSelection'), adminCredentials = document.getElementById('adminCredentials');
        const kelasSelect = document.getElementById('kelasSelect'), userNameSelect = document.getElementById('userName'), guruNameSelect = document.getElementById('guruName');
        const loginBtn = document.getElementById('loginBtn'), logoutBtn = document.getElementById('logoutBtn');
        const dashboardContent = document.getElementById('dashboardContent'), welcomeMessage = document.getElementById('welcomeMessage');
        const customAlert = document.getElementById('custom-alert'), alertMessage = document.getElementById('alert-message'), alertOkBtn = document.getElementById('alert-ok-btn');
        const cameraModal = document.getElementById('camera-modal'), closeCameraBtn = document.getElementById('close-camera-btn'), cameraFeed = document.getElementById('camera-feed'), cameraCanvas = document.getElementById('camera-canvas'), captureBtn = document.getElementById('capture-btn'), photoPreview = document.getElementById('photo-preview'), recaptureBtn = document.getElementById('recapture-btn'), confirmPhotoBtn = document.getElementById('confirm-photo-btn');
        const chatModal = document.getElementById('chat-modal'), closeChatBtn = document.getElementById('close-chat-btn'), chatStudentName = document.getElementById('chat-student-name'), chatMessages = document.getElementById('chat-messages'), chatInput = document.getElementById('chat-input'), sendChatBtn = document.getElementById('send-chat-btn');
        const detailModal = document.getElementById('detail-modal'), closeDetailModalBtn = document.getElementById('close-detail-modal'), detailModalTitle = document.getElementById('detail-modal-title'), detailModalContent = document.getElementById('detail-modal-content');
        let stream;

        // --- MOCK DATA ---
        const generateSiswa = () => {
            const firstNames = ["Ahmad", "Budi", "Cahya", "Dewi", "Eka", "Fitri", "Gilang", "Hana", "Indra", "Jihan", "Kevin", "Lia", "Mega"];
            const lastNames = ["Santoso", "Wijaya", "Kusuma", "Lestari", "Pratama", "Ningsih", "Wibowo", "Handayani", "Setiawan", "Putri", "Maulana"];
            let students = [];

            for (let i = 1; i <= 12; i++) {
                let classStudents = 0;
                let classNames = new Set(); 
                while (classStudents < 15) {
                    const fullName = `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;
                    if (!classNames.has(fullName)) { 
                        students.push({
                            name: fullName,
                            kelas: `XII-${i}`
                        });
                        classNames.add(fullName);
                        classStudents++;
                    }
                }
            }
            return students;
        };
        const data = {
            siswa: generateSiswa(),
            guru: [
                { name: 'Dodi Setiawan, S.Kom', mapel: 'Informatika', kelas: 'XII-1', gender: 'pria' },
                { name: 'Riza Lestari, S.Pd', mapel: 'Matematika', kelas: 'XII-2', gender: 'wanita' },
                { name: 'Dairotul Khasanah, M.Pd', mapel: 'Bahasa Inggris', kelas: 'XII-3', gender: 'wanita' },
                { name: 'Hadi Nugroho, S.Ag', mapel: 'Pendidikan Agama Islam', kelas: 'XII-4', gender: 'pria' },
                { name: 'Mardanih, S.Pd', mapel: 'Sejarah Indonesia', kelas: 'XII-5', gender: 'pria' },
                { name: 'Endang Susilowati, S.Si', mapel: 'Biologi', kelas: 'XII-6', gender: 'wanita' },
                { name: 'Budi Santoso, M.Si', mapel: 'Fisika', kelas: 'XII-7', gender: 'pria' },
                { name: 'Tita Rosita, S.T', mapel: 'Kimia', kelas: 'XII-8', gender: 'wanita' },
                { name: 'Agus Wijaya, S.Sos', mapel: 'Geografi', kelas: 'XII-9', gender: 'pria' },
                { name: 'Wati Kurnia, S.E', mapel: 'Ekonomi', kelas: 'XII-10', gender: 'wanita' },
                { name: 'Joko Susilo, S.Or', mapel: 'Pendidikan Jasmani', kelas: 'XII-11', gender: 'pria' },
                { name: 'Sri Handayani, M.Hum', mapel: 'Bahasa Indonesia', kelas: 'XII-12', gender: 'wanita' },
            ]
        };
        
        let pengajuanIzin = [];
        let chatHistory = {};

        // --- GLOBAL STATE ---
        let currentUser = {};

        // --- FUNCTIONS ---
        const showAlert = (message) => { alertMessage.textContent = message; customAlert.classList.remove('hidden'); };
        alertOkBtn.addEventListener('click', () => customAlert.classList.add('hidden'));

        const populateKelasSelect = () => {
            const kelasSet = new Set(data.siswa.map(s => s.kelas));
            const sortedKelas = Array.from(kelasSet).sort((a, b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
            kelasSelect.innerHTML = sortedKelas.map(k => `<option value="${k}">${k}</option>`).join('');
            populateSiswaSelect(kelasSelect.value);
        };
        
        const populateSiswaSelect = (kelas) => {
            userNameSelect.innerHTML = '';
            data.siswa.filter(s => s.kelas === kelas).forEach(s => {
                const option = document.createElement('option');
                option.value = s.name;
                option.textContent = s.name;
                userNameSelect.appendChild(option);
            });
        };
        
        const populateGuruSelect = () => {
            guruNameSelect.innerHTML = '';
            data.guru.forEach(g => {
                const option = document.createElement('option');
                option.value = g.name; // Keep the full name with title for data lookup
                const simpleName = g.name.split(',')[0]; // Get the name before the comma
                option.textContent = `${simpleName} (Walas ${g.kelas})`; // Display name + walas status
                guruNameSelect.appendChild(option);
            });
        };

        const switchRoleView = (role) => {
            siswaSelection.classList.toggle('hidden', role !== 'siswa');
            guruSelection.classList.toggle('hidden', role !== 'guru');
            adminCredentials.classList.toggle('hidden', role !== 'admin');
            if (role === 'siswa') populateKelasSelect();
            if (role === 'guru') populateGuruSelect();
        };
        
        // --- RENDER DASHBOARDS ---
        const renderDashboard = (role, user) => {
            dashboardContent.innerHTML = '';
            let template;
            currentUser = { role, name: user };

            if (role === 'siswa') {
                currentUser.kelas = kelasSelect.value;
                template = document.getElementById('siswa-dashboard').content.cloneNode(true);
                welcomeMessage.textContent = `Selamat Datang, ${user}! üíñ (${currentUser.kelas})`;
                dashboardContent.appendChild(template);
                setupSiswaDashboard();
            } else if (role === 'guru') {
                const guruData = data.guru.find(g => g.name === user);
                currentUser.guruData = guruData;
                template = document.getElementById('guru-dashboard').content.cloneNode(true);
                const simpleName = user.split(',')[0]; // Get the name before the comma
                welcomeMessage.textContent = `Selamat bertugas, ${simpleName}! üìö`; // Use the simpler name
                template.querySelector('#guru-kelas').textContent = guruData.kelas;
                template.querySelector('#guru-mapel').textContent = guruData.mapel;
                dashboardContent.appendChild(template);
                setupGuruDashboard();
            } else if (role === 'admin') {
                template = document.getElementById('admin-dashboard').content.cloneNode(true);
                welcomeMessage.textContent = `Selamat datang, Admin! ‚ú® Anda memiliki akses penuh.`;
                dashboardContent.appendChild(template);
                setupAdminDashboard();
            }
            loginPage.classList.add('hidden');
            dashboard.classList.remove('hidden');
        };

        const setupSiswaDashboard = () => {
            dashboardContent.querySelectorAll('.btn-absen').forEach(btn => btn.addEventListener('click', (e) => openCameraModal(e.target.dataset.type)));

            dashboardContent.querySelector('#izinForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const waliKelas = data.guru.find(g => g.kelas === currentUser.kelas);
                if (!waliKelas) {
                    showAlert('Wali kelas untuk kelas ini tidak ditemukan.');
                    return;
                }
                const salutation = waliKelas.gender === 'pria' ? 'Bapak' : 'Ibu';
                const alasan = dashboardContent.querySelector('#izinAlasan').value;

                const newIzin = {
                    id: Date.now(),
                    name: currentUser.name,
                    kelas: currentUser.kelas,
                    type: dashboardContent.querySelector('#izinTipe').value,
                    reason: alasan,
                    file: dashboardContent.querySelector('#izinFile').files.length > 0,
                    status: 'pending'
                };
                pengajuanIzin.push(newIzin);

                const initialMessage = `Assalamualaikum ${salutation} ${waliKelas.name}, saya orang tua dari siswa ${currentUser.name}, ingin memberitahukan bahwa anak saya tidak dapat hadir hari ini karena ${alasan}.`;
                if (!chatHistory[currentUser.name]) {
                    chatHistory[currentUser.name] = [];
                }
                chatHistory[currentUser.name].push({
                    sender: 'ortu',
                    text: initialMessage,
                    timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute:'2-digit' })
                });

                showAlert('Laporan izin/sakit berhasil dikirim ke wali kelas!');
                e.target.reset();
            });
        };

        const setupGuruDashboard = () => {
            dashboardContent.querySelectorAll('.btn-absen-guru').forEach(btn => btn.addEventListener('click', (e) => openCameraModal(e.target.dataset.type)));
            renderDaftarHadir(currentUser.guruData.kelas);
        };

        const setupAdminDashboard = () => {
            renderIzinListForAdmin();
            dashboardContent.querySelectorAll('.admin-stat-card').forEach(card => {
                card.addEventListener('click', () => {
                    showAdminDetailsModal(card.dataset.type);
                });
            });
        };

        const renderDaftarHadir = (kelas) => {
            const tableBody = document.getElementById('daftarHadirSiswa');
            tableBody.innerHTML = '';
            const siswaDiKelas = data.siswa.filter(s => s.kelas === kelas);
            let rekap = { Hadir: 0, Sakit: 0, Izin: 0, Alpa: 0 };

            siswaDiKelas.forEach(siswa => {
                const row = document.createElement('tr');
                row.className = "bg-white border-b";
                const izinSiswa = pengajuanIzin.find(p => p.name === siswa.name); // Find any izin request
                
                let izinInfoHtml = '<span>-</span>';
                let aksiHtml = `<button class="text-green-600 font-semibold text-xs hover:underline" onclick="window.openChatByName('${siswa.name}')"><i class="fab fa-whatsapp fa-lg mr-1"></i> Chat Ortu</button>`;
                let statusSiswa = 'Hadir';
                let isDropdownDisabled = false;

                if (izinSiswa) {
                    aksiHtml += `<button class="ml-4 text-blue-600 text-xs hover:underline" onclick="window.showIzinDetail('${izinSiswa.id}')"><i class="fa fa-eye"></i> Detail</button>`;
                    
                    if (izinSiswa.status === 'disetujui') {
                        statusSiswa = izinSiswa.type;
                        isDropdownDisabled = true;
                        izinInfoHtml = `<span class="font-semibold text-green-600">${izinSiswa.type} (Disetujui)</span>`;
                    } else if (izinSiswa.status === 'pending') {
                        statusSiswa = izinSiswa.type;
                        isDropdownDisabled = true;
                        izinInfoHtml = `<span class="font-semibold text-orange-500 animate-pulse">${izinSiswa.type} (Pending)</span>`;
                    } else if (izinSiswa.status === 'ditolak') {
                        isDropdownDisabled = false; // Teacher can override
                        izinInfoHtml = `<span class="font-semibold text-red-600">${izinSiswa.type} (Ditolak)</span>`;
                    }
                }

                if (statusSiswa === 'Sakit') rekap.Sakit++;
                else if (statusSiswa === 'Izin') rekap.Izin++;
                else rekap.Hadir++;
                
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium">${siswa.name}</td>
                    <td class="px-6 py-4">
                        <select class="p-1 rounded border-slate-300 text-xs bg-white" ${isDropdownDisabled ? 'disabled' : ''}>
                            <option ${statusSiswa === 'Hadir' ? 'selected' : ''}>Hadir</option>
                            <option ${statusSiswa === 'Sakit' ? 'selected' : ''}>Sakit</option>
                            <option ${statusSiswa === 'Izin' ? 'selected' : ''}>Izin</option>
                            <option>Alpa</option>
                        </select>
                    </td>
                    <td class="px-6 py-4">${izinInfoHtml}</td>
                    <td class="px-6 py-4">${aksiHtml}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Render Rekap Kelas for Guru
            const rekapContainer = document.getElementById('rekap-kelas-content');
            rekapContainer.innerHTML = `
                <div class="bg-green-100 p-3 rounded-lg"><p class="font-bold text-green-800 text-xl">${rekap.Hadir}</p><p class="text-xs text-green-600 font-medium">Hadir</p></div>
                <div class="bg-yellow-100 p-3 rounded-lg"><p class="font-bold text-yellow-800 text-xl">${rekap.Sakit}</p><p class="text-xs text-yellow-600 font-medium">Sakit</p></div>
                <div class="bg-blue-100 p-3 rounded-lg"><p class="font-bold text-blue-800 text-xl">${rekap.Izin}</p><p class="text-xs text-blue-600 font-medium">Izin</p></div>
                <div class="bg-red-100 p-3 rounded-lg"><p class="font-bold text-red-800 text-xl">${rekap.Alpa}</p><p class="text-xs text-red-600 font-medium">Alpa</p></div>
            `;
        };
        
        // NEW: Show Admin Details Modal
        const showAdminDetailsModal = (type) => {
            let title = '';
            let names = [];
            
            // This is using mock data. In a real app, you'd fetch this from the database.
            switch(type) {
                case 'siswa-hadir':
                    title = 'Daftar Siswa Hadir';
                    names = data.siswa.slice(0, 125).map(s => `${s.name} (${s.kelas})`);
                    break;
                case 'siswa-terlambat':
                    title = 'Daftar Siswa Terlambat';
                    names = data.siswa.slice(125, 130).map(s => `${s.name} (${s.kelas})`);
                    break;
                case 'siswa-alpa':
                    title = 'Daftar Siswa Alpa';
                    names = data.siswa.slice(130, 132).map(s => `${s.name} (${s.kelas})`);
                    break;
                case 'guru-hadir':
                    title = 'Daftar Guru Hadir';
                    names = data.guru.slice(0, 10).map(g => `${g.name} - ${g.mapel}`);
                    break;
            }

            detailModalTitle.textContent = title;
            detailModalContent.innerHTML = names.map(name => `<div class="p-2 bg-slate-50 rounded">${name}</div>`).join('');
            detailModal.classList.remove('hidden');
        };


        window.showIzinDetail = (id) => {
             const izin = pengajuanIzin.find(p => p.id == id);
             if(!izin) return;
             let detailText = `Laporan ${izin.type} dari Ortu ${izin.name} (Status: ${izin.status}).\nAlasan: ${izin.reason}\n${izin.file ? 'Surat terlampir.' : 'Tidak ada surat.'}`;
             showAlert(detailText);
        }
        
        const renderIzinListForAdmin = () => {
            const container = document.getElementById('izin-list');
            container.innerHTML = '';
            const pendingIzin = pengajuanIzin.filter(p => p.status === 'pending');

            if (pendingIzin.length > 0) {
                pendingIzin.forEach(izin => {
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded-lg bg-slate-50 transition-opacity duration-500';
                    card.dataset.id = izin.id;
                    card.innerHTML = `
                        <p class="font-bold">${izin.name} (${izin.kelas}) - <span class="font-normal text-sm ${izin.type === 'Sakit' ? 'text-orange-600' : 'text-blue-600'}">${izin.type}</span></p>
                        <p class="text-xs text-slate-500 mt-1">${izin.reason}</p>
                        ${izin.file ? `<button class="text-xs text-blue-500 hover:underline mt-1" onclick="showAlert('Menampilkan surat izin dari ${izin.name}...')"><i class="fa fa-paperclip mr-1"></i>Lihat Surat</button>` : ''}
                        <div class="text-right mt-2 space-x-2">
                            <button class="btn-konfirmasi setujui text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-action="disetujui">Setujui</button>
                            <button class="btn-konfirmasi tolak text-xs bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-action="ditolak">Tolak</button>
                        </div>`;
                    container.appendChild(card);
                });
                container.querySelectorAll('.btn-konfirmasi').forEach(btn => btn.addEventListener('click', handleKonfirmasiIzin));
            } else {
                container.innerHTML = `<p class="text-sm text-slate-500 text-center py-4">Tidak ada pengajuan izin saat ini. üéâ</p>`;
            }
        };

        const handleKonfirmasiIzin = (e) => {
            const card = e.target.closest('.p-3.border');
            const id = parseInt(card.dataset.id);
            const action = e.target.dataset.action;
            
            const izinIndex = pengajuanIzin.findIndex(p => p.id === id);
            if(izinIndex > -1) {
                pengajuanIzin[izinIndex].status = action;
                showAlert(`Pengajuan dari ${pengajuanIzin[izinIndex].name} telah ${action}.`);
                
                card.style.opacity = '0';
                setTimeout(() => {
                    renderIzinListForAdmin();
                    if(currentUser.role === 'guru') {
                        renderDaftarHadir(currentUser.guruData.kelas);
                    }
                }, 500);
            }
        };

        // --- CAMERA LOGIC ---
        let currentAbsenType = '';
        const openCameraModal = async (type) => {
            currentAbsenType = type;
            cameraModal.classList.remove('hidden');
            recaptureBtn.click();
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showAlert('Browser Anda tidak mendukung akses kamera.');
                closeCameraModal();
                return;
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                
                if (videoDevices.length === 0) {
                     showAlert('Tidak ada kamera yang terdeteksi pada perangkat Anda.');
                     closeCameraModal();
                     return;
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                cameraFeed.srcObject = stream;

            } catch (err) {
                console.error("Error accessing camera: ", err);
                let errorMessage = 'Tidak dapat mengakses kamera. Pastikan Anda memberikan izin kepada browser.';
                if (err.name === 'NotAllowedError') errorMessage = 'Akses kamera ditolak. Periksa pengaturan izin browser Anda.';
                else if (err.name === 'NotFoundError') errorMessage = 'Kamera tidak ditemukan. Pastikan terpasang dan berfungsi.';
                else if (err.name === 'NotReadableError') errorMessage = 'Kamera sedang digunakan oleh aplikasi lain.';
                showAlert(errorMessage);
                closeCameraModal();
            }
        };
        const closeCameraModal = () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');
        };
        captureBtn.addEventListener('click', () => {
            cameraCanvas.width = cameraFeed.videoWidth;
            cameraCanvas.height = cameraFeed.videoHeight;
            const context = cameraCanvas.getContext('2d');
            context.scale(-1, 1);
            context.drawImage(cameraFeed, -cameraCanvas.width, 0, cameraCanvas.width, cameraCanvas.height);
            
            photoPreview.src = cameraCanvas.toDataURL('image/webp');
            photoPreview.classList.remove('hidden');
            cameraFeed.classList.add('hidden');
            captureBtn.classList.add('hidden');
            recaptureBtn.classList.remove('hidden');
            confirmPhotoBtn.classList.remove('hidden');
        });
        recaptureBtn.addEventListener('click', () => {
            photoPreview.classList.add('hidden');
            cameraFeed.classList.remove('hidden');
            captureBtn.classList.remove('hidden');
            recaptureBtn.classList.add('hidden');
            confirmPhotoBtn.classList.add('hidden');
        });
        confirmPhotoBtn.addEventListener('click', () => {
            if (currentUser.role === 'siswa') {
                const absensiStatus = dashboardContent.querySelector('#absensi-status');
                const fotoContainer = dashboardContent.querySelector('#foto-bukti-container');
                fotoContainer.classList.remove('hidden');

                if (currentAbsenType === 'masuk') {
                    dashboardContent.querySelector('#fotoMasuk').src = photoPreview.src;
                    showAlert('Absen Masuk Berhasil! Foto selfie dan lokasi Anda telah direkam.');
                    dashboardContent.querySelector('.btn-absen[data-type="masuk"]').disabled = true;
                    dashboardContent.querySelector('.btn-absen[data-type="pulang"]').disabled = false;
                    absensiStatus.textContent = 'Status: Sudah Absen Masuk';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-green-100 text-green-800';
                } else {
                    dashboardContent.querySelector('#fotoPulang').src = photoPreview.src;
                    showAlert('Absen Pulang Berhasil! Sampai jumpa besok.');
                    dashboardContent.querySelector('.btn-absen[data-type="pulang"]').disabled = true;
                    absensiStatus.textContent = 'Status: Sesi Absen Selesai';
                    absensiStatus.className = 'font-bold text-xl p-3 rounded-lg bg-blue-100 text-blue-800';
                }
            } else if (currentUser.role === 'guru') {
                const absensiStatusGuru = dashboardContent.querySelector('#absensi-status-guru');
                const fotoContainerGuru = dashboardContent.querySelector('#foto-bukti-container-guru');
                fotoContainerGuru.classList.remove('hidden');
                dashboardContent.querySelector('#fotoMasukGuru').src = photoPreview.src;
                showAlert('Absen Masuk Guru Berhasil!');
                dashboardContent.querySelector('.btn-absen-guru[data-type="masuk"]').disabled = true;
                absensiStatusGuru.textContent = 'Status: Sudah Absen Masuk';
                absensiStatusGuru.className = 'font-bold text-xl p-3 rounded-lg bg-green-100 text-green-800';
            }
            closeCameraModal();
        });
        closeCameraBtn.addEventListener('click', closeCameraModal);
        
        // --- CHAT LOGIC ---
        window.openChatByName = (studentName) => {
            chatStudentName.textContent = studentName;
            chatMessages.innerHTML = '';

            const history = chatHistory[studentName] || [];
            if (history.length === 0) {
                 const systemMsg = `<div class="text-center my-2"><span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">Mulai percakapan baru</span></div>`;
                 chatMessages.innerHTML = systemMsg;
            } else {
                history.forEach(msg => {
                    const bubbleClass = msg.sender === 'guru' ? 'chat-bubble-sent' : 'chat-bubble-received';
                    const justifyClass = msg.sender === 'guru' ? 'justify-end' : 'justify-start';
                    const msgHtml = `
                        <div class="flex ${justifyClass}">
                            <div class="chat-bubble ${bubbleClass}">
                                ${msg.sender === 'ortu' ? `<p class="font-bold text-yellow-800">[Pesan dari Ortu]</p>`: ''}
                                <p>${msg.text}</p>
                                <div class="chat-timestamp">${msg.timestamp}</div>
                            </div>
                        </div>`;
                    chatMessages.insertAdjacentHTML('beforeend', msgHtml);
                });
            }
            
            chatModal.dataset.studentName = studentName;
            chatModal.classList.remove('hidden');
            chatInput.focus();
        };

        const simulateParentReply = (studentName) => {
            const replies = ["Baik Bapak/Ibu Guru, terima kasih atas informasinya.", "Siap, terima kasih banyak atas perhatiannya.", "Oh begitu, baik.", "Terima kasih, akan kami tindak lanjuti."];
            const messageText = replies[Math.floor(Math.random() * replies.length)];
            const newMessage = { sender: 'ortu', text: messageText, timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute:'2-digit' }) };
            chatHistory[studentName].push(newMessage);
            const msgHtml = `<div class="flex justify-start"><div class="chat-bubble chat-bubble-received"><p>${newMessage.text}</p><div class="chat-timestamp">${newMessage.timestamp}</div></div></div>`;
            chatMessages.insertAdjacentHTML('beforeend', msgHtml);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        };

        closeChatBtn.addEventListener('click', () => chatModal.classList.add('hidden'));

        const sendChatMessage = () => {
            const studentName = chatModal.dataset.studentName;
            const messageText = chatInput.value.trim();
            if (messageText === '') return;
            
            const newMessage = { sender: 'guru', text: messageText, timestamp: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute:'2-digit' }) };
            if (!chatHistory[studentName]) chatHistory[studentName] = [];
            chatHistory[studentName].push(newMessage);

            const msgHtml = `<div class="flex justify-end"><div class="chat-bubble chat-bubble-sent"><p>${newMessage.text}</p><div class="chat-timestamp">${newMessage.timestamp}</div></div></div>`;
            if (chatMessages.querySelector('.text-center')) { chatMessages.innerHTML = ''; }
            chatMessages.insertAdjacentHTML('beforeend', msgHtml);
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            setTimeout(() => simulateParentReply(studentName), 1500 + Math.random() * 2000);
        };
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

        // --- EVENT LISTENERS ---
        roleSelect.addEventListener('change', (e) => switchRoleView(e.target.value));
        kelasSelect.addEventListener('change', (e) => populateSiswaSelect(e.target.value));

        loginBtn.addEventListener('click', () => {
            const role = roleSelect.value;
            let user, isValid = false;

            if (role === 'admin') {
                if (document.getElementById('adminUser').value === 'admin' && document.getElementById('adminPass').value === 'admin123') { user = 'Admin'; isValid = true; } 
                else { showAlert('Username atau Password Admin salah!'); }
            } else if (role === 'siswa') { user = userNameSelect.value; isValid = true; } 
            else if (role === 'guru') { user = guruNameSelect.value; isValid = true; }

            if (isValid) renderDashboard(role, user);
        });
        
        closeDetailModalBtn.addEventListener('click', () => detailModal.classList.add('hidden'));

        logoutBtn.addEventListener('click', () => {
            dashboard.classList.add('hidden');
            loginPage.classList.remove('hidden');
            document.getElementById('adminUser').value = '';
            document.getElementById('adminPass').value = '';
        });

        // --- INITIALIZATION ---
        switchRoleView('siswa');
    });
    </script>
</body>
</html>

